<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Risk Register - Single Page Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Number inputs */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    /* Toggle switch */
    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .2s; border-radius: 9999px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 9999px; }
    .switch input:checked + .slider { background-color: #16a34a; }
    .switch input:checked + .slider:before { transform: translateX(20px); }

    /* Chips */
    .chip { transition: background .15s ease; }
    .chip:hover { filter: brightness(0.97); }

    /* Radar canvas */
    #radarChart { width: 100%; height: 300px; display: block; }

    /* Accordion chevron */
    details[open] summary .chev { transform: rotate(90deg); }

    /* Modal backdrop */
    .modal-backdrop { background-color: rgba(0,0,0,0.4); }

    /* Guidance collapse */
    .gpanel-collapsed { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; border-width: 0; overflow: hidden; }
    .gpanel-expanded { max-height: 24rem; opacity: 1; padding-top: 0.5rem; padding-bottom: 0.5rem; margin-top: 0.5rem; border-width: 1px; }

    /* ===== Tabs ===== */
    .tabs { display: flex; gap: .25rem; border-bottom: 1px solid #e2e8f0; }
    .tab-btn {
      padding: .5rem 1rem;
      border-radius: .5rem .5rem 0 0;
      border: 1px solid transparent;
      font-weight: 600;
      color: #475569;
      background: #f1f5f9;
    }
    .tab-btn:hover { background: #e2e8f0; }
    .tab-btn-active {
      color: #0f172a;
      background: #ffffff;
      border-color: #e2e8f0;
      border-bottom-color: transparent;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    .tbody-fade { transition: opacity .18s ease; opacity: 1; }

    
    .th-sort { background: transparent; border: 0; padding: 0; cursor: pointer; }
.th-sort:focus-visible { outline: 2px solid #94a3b8; outline-offset: 2px; }

    /* ===== RTE box ===== */
    .rte-box { border: 1px solid #e2e8f0; border-radius: .75rem; background: #fff; }
    .rte-toolbar {
      display: flex; gap: .5rem; flex-wrap: wrap;
      padding: .5rem; background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      border-top-left-radius: .75rem; border-top-right-radius: .75rem;
    }
    .rte-toolbar button {
      padding: .25rem .5rem; border-radius: .5rem;
      border: 1px solid #cbd5e1; background: #fff;
      font-size: .875rem; color: #334155;
    }
    .rte-toolbar button:hover { background: #f1f5f9; }
    .rte-editor {
      min-height: 140px; padding: .75rem; outline: none;
      border-bottom-left-radius: .75rem; border-bottom-right-radius: .75rem;
    }
    .rte-editor:focus { box-shadow: 0 0 0 2px rgba(59,130,246,.2); }

    /* ===== Sticky Aside on lg+ ===== */
    @media (min-width: 1024px){
      .sticky-aside {
        position: sticky;
        top: 1rem;
        align-self: flex-start;
      }
    }

    /* ===== Plan tab gap pill system ===== */
    .pill { padding: .25rem .5rem; border-radius: 9999px; font-size: .75rem; border: 1px solid transparent; }
    .pill-red    { background: #fee2e2; color: #991b1b; border-color: #fecaca; }   /* danger */
    .pill-amber  { background: #fef3c7; color: #92400e; border-color: #fde68a; }   /* addressed */
    .pill-muted  { background: transparent; color: #475569; border-color: #cbd5e1; opacity: .75; }
.gap-pill {
  padding: .25rem .5rem;
  border-radius: 9999px;
  font-size: .75rem;
  cursor: pointer;
  /* no background/border/color here */
}

/* (nice to have) keyboard focus */
.gap-pill:focus-visible {
  outline: 2px solid #94a3b8;
  outline-offset: 2px;
}
    /* File menu + status */
    .menu-open .menu-panel { display: block; }
    .pulse-dot { width:.5rem; height:.5rem; border-radius:9999px; display:inline-block; margin-right:.5rem; animation:pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%{transform:scale(1);opacity:1} 50%{transform:scale(.6);opacity:.6} 100%{transform:scale(1);opacity:1} }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

  <!-- ===== Top "File" menu bar (restored) ===== -->
  <nav class="bg-white border-b shadow-sm">
    <div class="max-w-7xl mx-auto px-6 py-2 flex items-center justify-between">
      <div class="relative" id="fileMenuRoot">
        <button id="fileMenuBtn" class="px-3 py-1.5 rounded-lg hover:bg-slate-100 font-medium">
          File ▾
        </button>
        <div id="fileMenuPanel"
             class="menu-panel hidden absolute z-50 mt-1 w-56 bg-white border rounded-xl shadow-lg overflow-hidden">
          <button id="menuNew" class="w-full text-left px-4 py-2 hover:bg-slate-50">New</button>
          <button id="menuOpen" class="w-full text-left px-4 py-2 hover:bg-slate-50">Open… (.litl)</button>
          <button id="menuSave" class="w-full text-left px-4 py-2 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Save</button>
          <button id="menuSaveAs" class="w-full text-left px-4 py-2 hover:bg-slate-50">Save As…</button>
        </div>
      </div>

      <!-- Status (top-right) -->
      <div id="fileStatus" class="text-sm text-slate-500 flex items-center gap-2">
        <span id="statusDot" class="inline-block w-2 h-2 rounded-full bg-slate-300"></span>
        <span id="statusText">Unsaved</span>
      </div>
    </div>
    <!-- Fallback input for Open if File System Access API unavailable -->
    <input id="openLitlInput" type="file" accept=".litl,application/x-litl" class="hidden" />
  </nav>

  <div class="max-w-7xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-3xl font-bold">Community Risk Register - Demo</h1>
      <p class="text-slate-600 mb-3">
        Manage <strong>Hazards</strong> and their <strong>Hazardous Events</strong>. Enter scores (1–5) across the seven NFCC-aligned dimensions. We'll roll them up and auto-generate a narrative.
      </p>
      <div class="flex flex-wrap items-center gap-3">
        <button id="addHazardBtn" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-medium">Add Hazard</button>
        <button id="addEventBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Add Hazardous Event</button>
        <!-- Removed: Copy Link / Save As buttons (now handled by File menu) -->
      </div>
    </header>

    <!-- List View -->
    <section id="listView" class="mb-6">
      <div class="bg-white rounded-2xl shadow p-5">
<div class="flex items-center justify-between mb-3">
  <h2 class="text-xl font-semibold">Hazards</h2>
  <div class="text-sm text-slate-500">Expand a hazard to view and edit its hazardous events</div>
</div>

<!-- New: list view tabs + search -->
<div class="flex items-center justify-between mb-3">
  <div class="tabs" id="listTabs">
    <button class="tab-btn tab-btn-active" data-listtab="grouped">Grouped by Hazard</button>
    <button class="tab-btn" data-listtab="all">All Events</button>
  </div>

  <div class="relative">
    <input id="listSearch" type="search" placeholder="Search event titles…"
           class="px-3 py-2 rounded-xl border w-64" />
    <!-- tiny clear button, optional -->
    <button id="listSearchClear"
            class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
            aria-label="Clear search" title="Clear search" type="button">×</button>
  </div>
</div>

        <div id="hazardsAccordion" class="space-y-3"></div>
      </div>
    </section>

    <!-- Editor View -->
    <div id="editorView" class="grid lg:grid-cols-3 gap-6 hidden">
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow p-5 space-y-6">

          <!-- Title + Hazard selection -->
          <div class="flex flex-col gap-3">
            <div class="flex items-center gap-3">
              <label for="riskTitle" class="font-semibold w-40">Event Title</label>
              <input id="riskTitle" type="text" placeholder="e.g., Dwelling Fire, RTC, Flooding"
                     class="flex-1 px-3 py-2 rounded-xl border" />
            </div>
            <div class="flex items-center gap-3">
              <label for="hazardSel" class="font-semibold w-40">Associated Hazard</label>
              <select id="hazardSel" class="px-3 py-2 rounded-xl border min-w-[16rem]"></select>
              <button id="cancelBtn" class="ml-auto px-3 py-2 rounded-xl border">Cancel</button>
              <button id="backToListBtn" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white">Back to List</button>
              <button id="resetBtn" class="px-3 py-2 rounded-xl border">Reset</button>
            </div>
          </div>

          <!-- ===== Tabs ===== -->
          <div class="tabs">
            <button class="tab-btn tab-btn-active" data-tab="details">Details</button>
            <button class="tab-btn" data-tab="risk">Community Risk</button>
            <button class="tab-btn" data-tab="plan">Plan</button>
          </div>

          <!-- ===== Details tab ===== -->
          <div id="tab_details" class="tab-panel active space-y-4 pt-4">
            <div class="border rounded-2xl p-4">
              <label class="block font-semibold mb-2">Description</label>
              <div class="rte-box">
                <div class="rte-toolbar">
                  <button type="button" data-cmd="bold"><strong>Bold</strong></button>
                  <button type="button" data-cmd="italic"><em>Italic</em></button>
                  <button type="button" data-cmd="insertUnorderedList">Bulleted</button>
                  <button type="button" data-cmd="insertOrderedList">Numbered</button>
                  <button type="button" data-link>Link</button>
                  <button type="button" data-clear>Clear</button>
                </div>
                <div id="descEditor" class="rte-editor" contenteditable="true" spellcheck="true"></div>
              </div>
            </div>

            <!-- Associated Links -->
            <div class="border rounded-2xl p-4">
              <div class="flex items-center justify-between mb-1">
                <label class="block font-semibold">Associated Links</label>
                <button id="addLinkBtn" class="px-3 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-700 text-white text-sm">+ Add Link</button>
              </div>
              <div id="linksList" class="mt-2 space-y-2"></div>
            </div>
          </div>

          <!-- ===== Risk tab ===== -->
          <div id="tab_risk" class="tab-panel space-y-4 pt-4">
            <div id="categories" class="flex flex-col gap-5"></div>
          </div>

          <!-- ===== Plan tab ===== -->
          <div id="tab_plan" class="tab-panel pt-4 space-y-4">
            <div class="border rounded-2xl p-4">
            <h3 class="text-lg font-semibold mb-2">Gaps Overview</h3>
            <!-- Grouped by Risk Group -->
            <div id="plan_gaps_by_group" class="space-y-3"></div>
            </div>


            <div class="border rounded-2xl p-4">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">Actions</h3>
                <button id="addActionBtn" class="px-3 py-1.5 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-sm">+ Add Action</button>
              </div>
              <div id="actionsList" class="mt-3 space-y-3"></div>
            </div>
          </div>
        </div>
      </section>

      <aside class="space-y-6 sticky-aside">
        <div class="bg-white rounded-2xl shadow p-5 space-y-3">
          <h3 class="text-lg font-semibold">Controls</h3>
          <div class="flex items-center gap-3">
            <label for="statusSel" class="font-medium w-24">Status</label>
            <select id="statusSel" class="px-3 py-2 rounded-xl border min-w-[12rem]">
              <option value="Tolerate">Tolerate</option>
              <option value="Treat">Treat</option>
              <option value="Transfer">Transfer</option>
              <option value="Terminate">Terminate</option>
            </select>
          </div>
          <div class="pt-2 border-t">
            <div class="flex flex-wrap gap-2">
              <button id="generateBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Generate Narrative</button>
              <button id="saveBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-medium">Save Event</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-2">Summary</h3>
          <div class="grid grid-cols-2 gap-3 text-sm" id="summaryPills"></div>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-3">Risk Profile</h3>
          <canvas id="radarChart" height="300"></canvas>
        </div>

        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-2">Auto-Narrative</h3>
          <p id="narrative" class="text-slate-700 leading-relaxed">Press <em>Generate Narrative</em> to produce a tailored summary.</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- Links modal -->
  <div id="linkModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
      <h4 class="text-lg font-semibold mb-4" id="linkModalTitle">Add Link</h4>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Title</label>
          <input id="linkTitleInput" type="text" class="w-full px-3 py-2 rounded-xl border" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Description</label>
          <textarea id="linkDescInput" rows="3" class="w-full px-3 py-2 rounded-xl border"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">URL</label>
          <input id="linkUrlInput" type="url" placeholder="https://…" class="w-full px-3 py-2 rounded-xl border" />
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="linkCancelBtn" class="px-4 py-2 rounded-xl border">Cancel</button>
        <button id="linkOkBtn" class="px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- Edit chip modal -->
  <div id="editModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6">
      <h4 id="editModalTitle" class="text-lg font-semibold mb-4">Edit</h4>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1">Title</label>
          <input id="editTitleInput" type="text" class="w-full px-3 py-2 rounded-xl border" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Details</label>
          <textarea id="editDetailsInput" rows="4" class="w-full px-3 py-2 rounded-xl border"></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="editCancelBtn" class="px-4 py-2 rounded-xl border">Cancel</button>
        <button id="editOkBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- Action (Plan) modal -->
  <div id="actionModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6">
      <h4 id="actionModalTitle" class="text-lg font-semibold mb-4">Add Action</h4>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Title</label>
          <input id="actionTitleInput" type="text" class="w-full px-3 py-2 rounded-xl border" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">Start</label>
            <input id="actionStartInput" type="date" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">End</label>
            <input id="actionEndInput" type="date" class="w-full px-3 py-2 rounded-xl border" />
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Outline Plan</label>
          <textarea id="actionOutlineInput" rows="3" class="w-full px-3 py-2 rounded-xl border"></textarea>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between">
          <h5 class="font-semibold">Select Gaps this action will address</h5>
          <div class="text-xs text-slate-500">Click to toggle selection</div>
        </div>
        <div id="actionGapPicker" class="mt-2 flex flex-wrap gap-2"></div>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button id="actionCancelBtn" class="px-4 py-2 rounded-xl border">Cancel</button>
        <button id="actionOkBtn" class="px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-700 text-white">Save Action</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const CFG = {
      categories: [
        { key:'people', title:'People', enabled:false, sub:[
          { id:'p_phys',  label:'Physical Harm' },
          { id:'p_psych', label:'Psychological Harm' },
          { id:'p_fin',   label:'Financial Harm' }
        ]},
        { key:'buildings', title:'Buildings & Infrastructure', enabled:false, sub:[
          {id:'b_stock', label:'Premises (domestic, commercial, industrial, heritage, high-risk)'},
          {id:'b_cni', label:'Critical national infrastructure (energy, water, transport, comms)'},
          {id:'b_transport', label:'Roads / rail / bridges / tunnels impacts'}
        ]},
        { key:'environment', title:'Environment', enabled:false, sub:[
          {id:'e_nat', label:'Natural environment (wildfire, flood, storms, climate)'},
          {id:'e_poll', label:'Pollution (chemical, smoke, water contamination)'},
          {id:'e_biodiv', label:'Biodiversity & heritage landscapes'}
        ]},
        { key:'ff', title:'Firefighter & Responder Safety', enabled:false, sub:[
          {id:'f_haz', label:'Exposure to hazardous materials'},
          {id:'f_struct', label:'Structural collapse / entrapment / fatigue'},
          {id:'f_psych', label:'Psychological harm and wellbeing'}
        ]},
        { key:'community', title:'Community & Society', enabled:false, sub:[
          {id:'c_trust', label:'Public expectations and trust in FRS'},
          {id:'c_cohesion', label:'Social cohesion / impacts on vulnerable communities'},
          {id:'c_disrupt', label:'Wider community impact of disruption / failure to respond'}
        ]},
        { key:'economy', title:'Economy / Business Continuity', enabled:false, sub:[
          {id:'ec_local', label:'Local economy (businesses, jobs, tourism)'},
          {id:'ec_supply', label:'Supply chains / critical services disruption'},
          {id:'ec_fin', label:'Financial harm to individuals / communities'}
        ]},
        { key:'reputation', title:'Reputation / Organisational Impact', enabled:false, sub:[
          {id:'r_conf', label:'Confidence in the service'},
          {id:'r_legal', label:'Legal / statutory compliance'},
          {id:'r_multi', label:'Impact on partner agencies / multi-agency reputation'}
        ]}
      ],
      likelihoodId:'o_likelihood',
      radarMax: 6,
      mitigationSteps: { 1:0.00, 2:0.10, 3:0.25, 4:0.40, 5:0.60 }
    };

    // Guidance example
    const GUIDANCE = {
      p_phys: [
        'None / negligible injury',
        'Minor first aid',
        'Medical attention required',
        'Serious injury / hospitalization',
        'Multiple serious injuries / fatalities'
      ],
      p_psych: [
        'No noticeable impact',
        'Temporary distress',
        'Short-term clinical support needed',
        'Long-term individual impact',
        'Widespread or severe psychological harm'
      ],
      p_fin: [
        'No measurable cost',
        'Minor personal costs',
        'Significant personal/household costs',
        'Severe financial hardship',
        'Widespread financial harm'
      ]
    };
    
        // ===== Global event list sorting =====
    
    // ===== List view state (mode + search) =====
let LIST_VIEW_MODE = 'grouped'; // 'grouped' | 'all'
let LIST_SEARCH = '';           // current query

function normalize(s){ return (s||'').toString().toLowerCase(); }
function filterItemsBySearch(items){
  const q = normalize(LIST_SEARCH).trim();
  if(!q) return items;
  return items.filter(ev => normalize(ev.title).includes(q));
}

// Update the tab button styles
function updateListTabsUI(){
  document.querySelectorAll('[data-listtab]').forEach(b=>{
    const on = (b.getAttribute('data-listtab') === LIST_VIEW_MODE);
    b.classList.toggle('tab-btn-active', on);
    b.classList.toggle('tab-btn-inactive', !on);
  });
}

    
    const EVENT_SORT = { key: 'score', dir: 'desc' }; // default: Risk Score ↓

    const sortComparators = {
      title: (a,b)=> (a.title||'').localeCompare(b.title||'', undefined, {sensitivity:'base'}),
      status:(a,b)=> (a.status||'').localeCompare(b.status||'', undefined, {sensitivity:'base'}),
      score: (a,b)=> Number((a.framework7||{}).overall||0) - Number((b.framework7||{}).overall||0)
    };

    function sortEvents(rows){
      const cmp = sortComparators[EVENT_SORT.key] || sortComparators.score;
      const out = rows.slice().sort(cmp);
      if (EVENT_SORT.dir === 'desc') out.reverse();
      return out;
    }
    function sortHazardsByTitle(hazards){
      return hazards.slice().sort((a,b)=> (a.title||'').localeCompare(b.title||'', undefined, {sensitivity:'base'}));
    }
    function sortIcon(key){
      if (EVENT_SORT.key !== key) return '';
      return EVENT_SORT.dir === 'asc' ? ' ▲' : ' ▼';
    }
function handleHeaderClick(key){
  if (EVENT_SORT.key === key){
    EVENT_SORT.dir = EVENT_SORT.dir === 'asc' ? 'desc' : 'asc';
  } else {
    EVENT_SORT.key = key;
    EVENT_SORT.dir = (key === 'score' ? 'desc' : 'asc');
  }
  resortAllTablesInPlace();
  updateSortIndicators(document.getElementById('hazardsAccordion'));
}



    // ===== Store =====
    let editingId = null;
    let editingHazardId = null;

    const SessionStore = {
      _items: [],
      _hazards: [],
      _nextItemId: 1,
      _nextHazId: 1,

      add(rec){ const id=this._nextItemId++; const copy={...rec, id}; this._items.unshift(copy); return Promise.resolve({id}); },
      put(rec){
        if(!rec.id) return this.add(rec);
        const i=this._items.findIndex(x=>x.id===rec.id);
        const c=JSON.parse(JSON.stringify(rec));
        if(i>-1) this._items[i]=c; else this._items.unshift(c);
        return Promise.resolve({id:rec.id});
      },
      getAll(){ return Promise.resolve(this._items.map(x=>JSON.parse(JSON.stringify(x)))); },
      get(id){ const it=this._items.find(x=>x.id===id); return Promise.resolve(it? JSON.parse(JSON.stringify(it)) : null ); },
      delete(id){ this._items = this._items.filter(x=>x.id!==id); return Promise.resolve(); },

      addHazard(title){ const id=this._nextHazId++; this._hazards.push({ id, title: String(title||'Untitled Hazard').trim() }); return Promise.resolve({id}); },
      putHazard(haz){ const i=this._hazards.findIndex(h=>h.id===haz.id); if(i>-1) this._hazards[i] = { id: haz.id, title: String(haz.title||'Untitled Hazard').trim() }; return Promise.resolve({id: haz.id}); },
      getAllHazards(){ return Promise.resolve(this._hazards.map(h=> ({ id:h.id, title:h.title }) )); },
      deleteHazard(id){
        this._hazards = this._hazards.filter(h=>h.id!==id);
        this._items = this._items.map(ev => (ev.hazardId===id ? { ...ev, hazardId: null } : ev));
        return Promise.resolve();
      },

      setAll(payload){
        const items = Array.isArray(payload?.items) ? payload.items : [];
        const hazards = Array.isArray(payload?.hazards) ? payload.hazards : [];
        this._items = []; this._hazards = [];
        this._nextItemId = 1; this._nextHazId = 1;
        hazards.forEach(h => { this._hazards.push({ id: this._nextHazId++, title: String(h.title||'Untitled Hazard') }); });
        items.forEach(it => { this._items.push({ ...it, id: this._nextItemId++ }); });
      }
    };

    // ===== Helpers =====
    const el = (id)=> document.getElementById(id);
    const clamp15 = (n)=> Math.max(1, Math.min(5, Number(n||0)));
    const round1 = (x)=> Math.round(x*10)/10;
    const enabledOf = (key)=> (el('en_'+key)?.checked ?? false);
    const escapeHtml = (s)=> String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    function mitigationReduction(eff){
      const e = clamp15(eff);
      if (CFG.mitigationSteps) { const v = CFG.mitigationSteps[e]; return typeof v === 'number' ? v : 0; }
      return ((e-1)/4) * 0.4;
    }

    function riskClass(score){
      const s = Number(score||0);
      if (s > 25) return { label:'Extremely High', cls:'bg-rose-100 text-rose-800' };
      if (s >= 21) return { label:'Very High', cls:'bg-rose-100 text-rose-800' };
      if (s >= 16) return { label:'High', cls:'bg-orange-100 text-orange-800' };
      if (s >= 11) return { label:'Moderate', cls:'bg-amber-100 text-amber-800' };
      if (s >= 6)  return { label:'Low', cls:'bg-yellow-100 text-yellow-800' };
      return { label:'Very Low', cls:'bg-emerald-100 text-emerald-800' };
    }

    // ===== File/save-state tracking =====
    let currentFileHandle = null;
    let currentFileName = null;
    let fileDirty = false;
    let saving = false;
    let lastSavedSnapshot = '';

    const statusDotEl  = () => el('statusDot');
    const statusTextEl = () => el('statusText');

    function formatTime(d=new Date()){
      const hh = d.getHours().toString().padStart(2,'0');
      const mm = d.getMinutes().toString().padStart(2,'0');
      return `${hh}:${mm}`;
    }
    function refreshStatus(){
      const dot = statusDotEl(); const text = statusTextEl();
      if (!dot || !text) return;
      let base = currentFileName ? `File: ${currentFileName}` : 'Unsaved';
      if (saving) { dot.className = 'pulse-dot bg-sky-500'; text.textContent = `${base} • Saving…`; return; }
      if (fileDirty) { dot.className = 'inline-block w-2 h-2 rounded-full bg-amber-500'; text.textContent = `${base} • Unsaved changes`; return; }
      dot.className = 'inline-block w-2 h-2 rounded-full bg-emerald-500'; text.textContent = `${base} • Saved ${formatTime()}`;
    }
    function canUsePicker(){ return !!(window.showOpenFilePicker && window.showSaveFilePicker); }
    function canSave(){ return !!(currentFileHandle && currentFileHandle.createWritable); }
    function updateFileMenuState(){ el('menuSave').disabled = !canSave(); refreshStatus(); }
    async function getDatasetSnapshotString(){
      const [items, hazards] = await Promise.all([SessionStore.getAll(), SessionStore.getAllHazards()]);
      items.sort((a,b)=> (a.id||0)-(b.id||0));
      hazards.sort((a,b)=> (a.id||0)-(b.id||0));
      return JSON.stringify({ items, hazards });
    }
    async function updateSavedSnapshot(){ lastSavedSnapshot = await getDatasetSnapshotString(); fileDirty = false; refreshStatus(); }
    async function recomputeDirtyAgainstSnapshot(){ const snap = await getDatasetSnapshotString(); fileDirty = (snap !== lastSavedSnapshot); refreshStatus(); }

    // ===== Guidance UI =====
    function renderGuidanceHtml(id, lines){
      if (!Array.isArray(lines) || !lines.length) return '';
      const n = lines.length;
      const items = lines.slice().reverse().map((txt, idx)=> {
        const step = n - idx;
        return `
          <li class="flex gap-2 items-start" data-step="${step}">
            <span class="inline-block w-5 text-right text-sky-800 font-semibold">${step}</span>
            <span class="flex-1">${escapeHtml(txt)}</span>
          </li>
        `;
      }).join('');
      return `
        <div id="g_${id}" class="rounded-xl bg-sky-50 text-sky-800 px-3 text-sm overflow-hidden transition-all duration-200 ease-out gpanel-collapsed border border-sky-200">
          <div class="font-medium mb-1">Scoring guide</div>
          <ul class="list-none pl-0 space-y-1">${items}</ul>
        </div>
      `;
    }
    function showGuide(panelId){ const d = el(panelId); if(!d) return; d.classList.remove('gpanel-collapsed'); d.classList.add('gpanel-expanded'); }
    function hideGuide(panelId){ const d = el(panelId); if(!d) return; d.classList.remove('gpanel-expanded'); d.classList.add('gpanel-collapsed'); }
    function updateGuidanceHighlight(subId){
      const panel = el('g_'+subId); if(!panel) return;
      const input = el(subId); if(!input) return;
      const val = clamp15(input.value);
      const lis = panel.querySelectorAll('li[data-step]');
      lis.forEach(li=>{
        if(Number(li.getAttribute('data-step'))===val){
          li.classList.add('bg-sky-100','rounded','px-2','py-0.5','font-medium');
        } else {
          li.classList.remove('bg-sky-100','rounded','px-2','py-0.5','font-medium');
        }
      });
    }
    
    async function renderAllEventsTable(items){
  const root = document.getElementById('hazardsAccordion');
  const rowsSorted = sortEvents(items || []);

  root.innerHTML = `
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm" id="allEventsTable" data-hazard="all">
        <thead>
          <tr class="text-left">
            <th class="py-2 pr-4">
              <button class="th-sort font-semibold" data-sort="title" type="button">Event Title</button>
            </th>
            <th class="py-2 pr-4">
              <button class="th-sort font-semibold" data-sort="score" type="button">Risk Score</button>
            </th>
            <th class="py-2 pr-4">
              <button class="th-sort font-semibold" data-sort="status" type="button">Status</button>
            </th>
            <th class="py-2 pr-4">Actions</th>
          </tr>
        </thead>
        <tbody class="tbody-fade">${buildEventRowsHTML(rowsSorted)}</tbody>
      </table>
    </div>
  `;

  const tbl = root.querySelector('#allEventsTable');
  wireRowActions(tbl);

  // Header clicks – same global sort, but resort just this table
  root.querySelectorAll('.th-sort').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      const key = btn.getAttribute('data-sort');
      if (EVENT_SORT.key === key){
        EVENT_SORT.dir = (EVENT_SORT.dir === 'asc' ? 'desc' : 'asc');
      } else {
        EVENT_SORT.key = key;
        EVENT_SORT.dir = (key === 'score' ? 'desc' : 'asc');
      }
      updateSortIndicators(root);
      resortAllEventsInPlace(); // fade/swap within this table
    });
  });

  updateSortIndicators(root);
  updateAriaSort(root);
}

async function resortAllEventsInPlace(){
  const tbl = document.getElementById('allEventsTable');
  if(!tbl) return;
  const tbody = tbl.querySelector('tbody');
  const items = await SessionStore.getAll();
  const filtered = filterItemsBySearch(items);
  const sorted = sortEvents(filtered);

  tbody.style.opacity = '0';
  setTimeout(()=>{
    tbody.innerHTML = buildEventRowsHTML(sorted);
    wireRowActions(tbl);
    tbody.style.opacity = '1';
  }, 180);

  updateAriaSort(tbl.closest('#hazardsAccordion') || document);
}


    // ===== Build Category UI =====
    const catRoot = el('categories');

    function renderSubRow(sf){
      const guidance = GUIDANCE?.[sf.id];
      return `
        <div class="subrow">
          <div class="flex items-center justify-between gap-3">
            <label class="w-56">${sf.label}</label>
            <input id="${sf.id}" type="number" min="1" max="5" value="3" class="w-20 text-center border rounded-lg py-1" />
          </div>
          ${guidance ? renderGuidanceHtml(sf.id, guidance) : ''}
        </div>
      `;
    }

    function buildCategoryBlocks(){
      const frag = document.createDocumentFragment();
      CFG.categories.forEach(cat=>{
        const box = document.createElement('div');
        box.className = 'border rounded-2xl p-4';
        box.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-semibold">${cat.title}</h2>
            <div class="flex items-center gap-2">
              <span class="text-sm text-slate-600">Include</span>
              <label class="switch">
                <input id="en_${cat.key}" type="checkbox" ${cat.enabled?'checked':''}>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div id="sec_${cat.key}_body" class="space-y-3">
            ${cat.sub.map(sf => renderSubRow(sf)).join('')}
            <div class="flex items-center justify-between gap-3 pt-2 border-t">
              <span class="w-56 font-medium">Inherent ${cat.title} Score</span>
              <output id="roll_${cat.key}" class="w-24 text-center font-semibold">3.0</output>
            </div>

            <!-- Mitigations -->
            <div class="mt-3 p-3 rounded-xl bg-emerald-50 border border-emerald-200">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-emerald-900">Existing mitigations</span>
                <div class="flex items-center gap-2">
                  <input id="mit_${cat.key}_input" type="text" placeholder="Add a mitigation…" class="px-2 py-1 text-sm border rounded-lg w-56" />
                  <button id="mit_${cat.key}_add" class="px-2 py-1 text-sm rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">+ Add</button>
                </div>
              </div>
              <div id="mit_${cat.key}_list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Gaps -->
            <div class="mt-3 p-3 rounded-xl bg-rose-50 border border-rose-200">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-rose-900">Identified gaps</span>
                <div class="flex items-center gap-2">
                  <input id="gap_${cat.key}_input" type="text" placeholder="Add a gap…" class="px-2 py-1 text-sm border rounded-lg w-56" />
                  <button id="gap_${cat.key}_add" class="px-2 py-1 text-sm rounded-lg bg-rose-600 hover:bg-rose-700 text-white">+ Add</button>
                </div>
              </div>
              <div id="gap_${cat.key}_list" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="flex items-center justify-between gap-3 mt-2">
              <label class="w-56">Mitigation effectiveness (1-5)</label>
              <input id="eff_${cat.key}" type="number" min="1" max="5" value="1" class="w-20 text-center border rounded-lg py-1" />
            </div>

            <div class="flex items-center justify-between gap-3 pt-2 border-t">
              <span class="w-56 font-medium">Current ${cat.title} Score</span>
              <output id="roll_adj_${cat.key}" class="w-24 text-center font-semibold">3.0</output>
            </div>
          </div>`;
        frag.appendChild(box);
      });

      const like = document.createElement('div');
      like.className = 'border rounded-2xl p-4';
      like.innerHTML = `
        <h2 class="text-xl font-semibold mb-2">Likelihood</h2>
        <div class="flex items-center justify-between gap-3">
          <label class="w-56">Likelihood of occurrence</label>
          <input id="${CFG.likelihoodId}" type="number" min="1" max="5" value="3" class="w-20 text-center border rounded-lg py-1" />
        </div>
        <div class="flex items-center justify-between gap-3 pt-2 border-t">
          <span class="w-56 font-medium">Overall (L × Max current)</span>
          <output id="overall_out" class="w-24 text-center font-semibold">0.0</output>
        </div>`;
      frag.appendChild(like);

      catRoot.appendChild(frag);
      CFG.categories.forEach(c=> toggleSectionBody(c.key, enabledOf(c.key)) );
    }

    // ===== Summary pills =====
    const pillsRoot = el('summaryPills');
    function buildPillsDynamic(rollsAdj, perCatRisk, overall){
      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      let html = enabledCats.map(cat=>{
        const val = Number.isFinite(perCatRisk?.[cat.key]) ? Number(perCatRisk[cat.key]) : 0;
        const rc = riskClass(val);
        return `
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">${cat.title}</div>
          <div id="pill_${cat.key}" class="text-2xl font-bold">${val.toFixed(1)}</div>
          <div class="text-xs ${rc.cls} inline-block mt-1 px-2 py-0.5 rounded-full">${rc.label}</div>
        </div>`;
      }).join('');
      const ov = Number.isFinite(overall) ? overall : 0;
      const rcOv = riskClass(ov);
      html += `
        <div class="p-3 rounded-xl bg-slate-50 col-span-2">
          <div class="text-slate-500">Overall (Max impact × L)</div>
          <div id="pill_overall" class="text-2xl font-bold">${ov.toFixed(1)}</div>
          <div class="text-xs ${rcOv.cls} inline-block mt-1 px-2 py-0.5 rounded-full">${rcOv.label}</div>
        </div>`;
      pillsRoot.innerHTML = html;
    }

    // ===== Calculations =====
    function calcRoll(cat){
      const vals = cat.sub.map(sf=> clamp15(el(sf.id).value));
      if(!vals.length) return 0;
      const sorted = vals.slice().sort((a,b)=> b-a);
      const top = sorted[0];
      const others = sorted.slice(1);
      const sumOthersTenths = others.reduce((a,b)=> a + (b/10), 0);
      return round1(top + sumOthersTenths);
    }
    function calcAdjusted(cat){
      const base = calcRoll(cat);
      const eff = clamp15(el('eff_'+cat.key).value);
      const reduction = mitigationReduction(eff);
      const adj = Math.max(0, base * (1 - reduction));
      return { base, eff, adj: round1(adj) };
    }
    function recalc(){
      const rollsAdj = {};
      CFG.categories.forEach(cat=>{
        const { base, adj } = calcAdjusted(cat);
        el('roll_'+cat.key).textContent = base.toFixed(1);
        el('roll_adj_'+cat.key).textContent = adj.toFixed(1);
        if(enabledOf(cat.key)) rollsAdj[cat.key] = adj;
      });
      const like = clamp15(el(CFG.likelihoodId).value);
      const perCatRisk = {};
      Object.keys(rollsAdj).forEach(k=>{ perCatRisk[k] = round1(rollsAdj[k] * like); });
      const vals = Object.values(rollsAdj);
      const maxAdj = vals.length ? Math.max(...vals) : 0;
      const overall = round1(maxAdj * like);
      el('overall_out').textContent = overall.toFixed(1);
      buildPillsDynamic(rollsAdj, perCatRisk, overall);
      drawRadar(rollsAdj);
    }

    // ===== Mitigations & Gaps chips =====
    function renderTagChip({type, key, title, details}){
      const wrap = document.createElement('span');
      const baseBg = (type==='mit'?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800');
      const baseHover = (type==='mit'?'hover:bg-emerald-200':'hover:bg-rose-200');
      wrap.className = `chip inline-flex items-center gap-1 px-2 py-1 rounded-full ${baseBg} text-xs`;
      wrap.setAttribute('data-type', type);
      wrap.setAttribute('data-key', key);
      wrap.setAttribute('data-title', title||'');
      wrap.setAttribute('data-details', details||'');
      wrap.innerHTML = `
        <button type="button" class="rounded px-1 ${baseHover}" title="Edit" data-role="edit">✎</button>
        <span class="truncate max-w-[12rem]" title="${escapeHtml(title||'')}" data-role="text">${escapeHtml(title||'')}</span>
        <button type="button" class="rounded px-1 ${baseHover}" title="Remove" data-role="remove">×</button>
      `;
      wrap.querySelector('[data-role="edit"]').addEventListener('click', (e)=>{ e.stopPropagation(); openEditModal(wrap); });
      wrap.querySelector('[data-role="remove"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        if(confirm('Are you sure you want to remove this item?')) { wrap.remove(); recalc(); renderPlanGaps(); markDirty(); }
      });
      return wrap;
    }
    function addTag(type, key, title, details){
      const list = (type==='mit'? el(`mit_${key}_list`) : el(`gap_${key}_list`));
      if(!list) return;
      const chip = renderTagChip({type, key, title:String(title||'').trim(), details:String(details||'').trim()});
      list.appendChild(chip);
      recalc(); renderPlanGaps(); markDirtySoon();
    }
    function setTags(type, key, arr){
      const list = (type==='mit'? el(`mit_${key}_list`) : el(`gap_${key}_list`));
      if(!list) return;
      list.innerHTML='';
      (arr||[]).forEach(item=>{
        if(item==null) return;
        if(typeof item==='string') addTag(type, key, item, '');
        else addTag(type, key, item.title||'', item.details||'');
      });
    }
    function collectTags(type, key){
      const list = (type==='mit'? el(`mit_${key}_list`) : el(`gap_${key}_list`));
      if(!list) return [];
      return Array.from(list.querySelectorAll('span[data-type]')).map(s=>({
        title: s.getAttribute('data-title') || '',
        details: s.getAttribute('data-details') || ''
      }));
    }
    const getMitigations = (key)=> collectTags('mit', key);
    const getGaps = (key)=> collectTags('gap', key);
    const setMitigations = (key, arr)=> setTags('mit', key, arr);
    const setGaps = (key, arr)=> setTags('gap', key, arr);

    // ===== Chip edit modal =====
    function openEditModal(chipEl){
      const isMit = chipEl.getAttribute('data-type')==='mit';
      el('editModalTitle').textContent = isMit ? 'Edit Mitigation' : 'Edit Gap';
      el('editTitleInput').value = chipEl.getAttribute('data-title') || '';
      el('editDetailsInput').value = chipEl.getAttribute('data-details') || '';
      el('editModal').classList.remove('hidden'); el('editModal').classList.add('flex');
      el('editOkBtn').onclick = ()=>{
        const t = el('editTitleInput').value.trim();
        const d = el('editDetailsInput').value.trim();
        chipEl.setAttribute('data-title', t);
        chipEl.setAttribute('data-details', d);
        const textNode = chipEl.querySelector('[data-role="text"]');
        textNode.textContent = t || '(untitled)';
        textNode.title = t || '(untitled)';
        el('editModal').classList.add('hidden'); el('editModal').classList.remove('flex');
        el('editOkBtn').onclick = null; el('editCancelBtn').onclick = null;
        recalc(); renderPlanGaps(); markDirtySoon();
      };
      el('editCancelBtn').onclick = ()=>{
        el('editModal').classList.add('hidden'); el('editModal').classList.remove('flex');
        el('editOkBtn').onclick = null; el('editCancelBtn').onclick = null;
      };
    }

    // ===== Radar =====
    function drawRadar(rolls){
      const canvas = document.getElementById('radarChart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      if (!canvas.style.width) canvas.style.width = '100%';
      if (!canvas.style.height) canvas.style.height = '300px';
      const rect = canvas.getBoundingClientRect();
      const cssW = Math.max(1, rect.width || 300);
      const cssH = Math.max(1, rect.height || 300);
      canvas.width = Math.round(cssW * dpr); canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      const labels = enabledCats.map(c=>c.title);
      const values = enabledCats.map(c=> rolls[c.key] ?? 0);
      if (!labels.length) { return; }
      const max = 6;

      const pad = 24; const cx = cssW/2; const cy = cssH/2; const radius = Math.min(cssW, cssH)/2 - pad - 10;
      const steps = max;

      ctx.lineWidth = 1;
      ctx.strokeStyle = '#cbd5e1';

      for(let s=1; s<=steps; s++){
        const r = radius * (s/max);
        ctx.beginPath();
        for(let i=0;i<labels.length;i++){
          const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
          const x = cx + r * Math.cos(ang);
          const y = cy + r * Math.sin(ang);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath(); ctx.stroke();
      }

      ctx.strokeStyle = '#e2e8f0';
      for(let i=0;i<labels.length;i++){
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const x = cx + radius * Math.cos(ang);
        const y = cy + radius * Math.sin(ang);
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
      }

      ctx.fillStyle = '#475569';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      for(let i=0;i<labels.length;i++){
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const lx = cx + (radius + 12) * Math.cos(ang);
        const ly = cy + (radius + 12) * Math.sin(ang);
        ctx.fillText(labels[i], lx, ly);
      }

      const points = values.map((v,i)=>{
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const r = radius * (v/max);
        return [cx + r*Math.cos(ang), cy + r*Math.sin(ang)];
      });
      ctx.beginPath();
      points.forEach(([x,y],i)=>{ if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.closePath();
      ctx.fillStyle = 'rgba(99,102,241,0.15)';
      ctx.strokeStyle = 'rgba(99,102,241,0.9)';
      ctx.lineWidth = 2;
      ctx.fill(); ctx.stroke();
      ctx.fillStyle = 'rgba(99,102,241,0.9)';
      points.forEach(([x,y])=>{ ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
    }

    // ===== Narrative =====
    function genNarrative(){
      const title = (el('riskTitle').value||'This hazardous event').trim();
      const like = clamp15(el(CFG.likelihoodId).value);
      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      const adjs = {}; enabledCats.forEach(cat=>{ adjs[cat.key]=calcAdjusted(cat).adj; });
      const maxCat = enabledCats.length ? enabledCats.reduce((best,cur)=> (adjs[cur.key] > adjs[best.key] ? cur : best), enabledCats[0]) : null;
      const strong = enabledCats.filter(c=> adjs[c.key] >= 4.8).map(c=>c.title);

      const parts = [];
      parts.push(`${title} has a likelihood of ${like}/5${maxCat?` with strongest current impacts in ${maxCat.title}.`:'.'}`);
      if(strong.length) parts.push('High-impact categories (after mitigation) include: ' + strong.join(', ') + '.');
      if(maxCat){
        const topMits = getMitigations(maxCat.key).map(m=>m.title).filter(Boolean);
        if(topMits.length){ parts.push(`Existing mitigations for ${maxCat.title}: ${topMits.slice(0,3).join('; ')}${topMits.length>3?' …':''}.`); }
        const topGaps = getGaps(maxCat.key).map(g=>g.title).filter(Boolean);
        if(topGaps.length){ parts.push(`Key gaps for ${maxCat.title}: ${topGaps.slice(0,3).join('; ')}${topGaps.length>3?' …':''}.`); }
      }
      parts.push('Priorities should focus on prevention, preparedness, and mitigation aligned to the highest residual risks.');
      el('narrative').textContent = parts.join(' ');
    }

    // ===== Import/Export (deep-link) =====
    function toBase64Safe(str){ try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); } }
    function fromBase64Safe(b64){ try { return decodeURIComponent(escape(atob(b64))); } catch(e){ return atob(b64); } }
    function getAppUrl(){ const href=(location.href||'').split('#')[0]; return href; }

    function importFromHash(){
      if(!location.hash || !location.hash.startsWith('#import=')) return;
      const enc = location.hash.slice('#import='.length);
      try{
        const json = fromBase64Safe(enc);
        const data = JSON.parse(json);
        const payload = {
          hazards: Array.isArray(data?.hazards) ? data.hazards : [],
          items: Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : [])
        };
        SessionStore.setAll(payload);
        refreshHazardsAccordion();
        recalc();
        updateSavedSnapshot();
        updateFileMenuState();
        alert('Imported from link');
      }catch(e){
        console.error('Hash import failed', e);
        alert('Failed to import from link');
      } finally {
        history.replaceState(null, document.title, location.pathname + location.search);
      }
    }

    // ===== Collect/Save (event) =====
    function collectCurrent(){
      const detailsHtml = el('descEditor').innerHTML || '';

      const inputs={}; CFG.categories.forEach(c=> c.sub.forEach(sf=> inputs[sf.id]=el(sf.id).value ));
      inputs[CFG.likelihoodId]=el(CFG.likelihoodId).value;
      const rolls={}; const adjs={}; const effs={}; const enabled={}; const risks={};
      CFG.categories.forEach(c=>{ const r=calcAdjusted(c); rolls[c.key]=r.base; adjs[c.key]=r.adj; effs[c.key]=r.eff; enabled[c.key]=enabledOf(c.key); });
      const like=clamp15(inputs[CFG.likelihoodId]);
      Object.keys(adjs).forEach(k=>{ if(enabled[k]) risks[k]=round1(adjs[k]*like); });
      const currentVals = Object.entries(adjs).filter(([k,_])=> enabled[k]).map(([_,v])=>v);
      const overall = round1((currentVals.length? Math.max(...currentVals):0) * like);
      const mitigations={}; CFG.categories.forEach(c=> mitigations[c.key]=getMitigations(c.key));
      const gaps={}; CFG.categories.forEach(c=> gaps[c.key]=getGaps(c.key));

      const links = getLinks();
      const actions = JSON.parse(JSON.stringify(planActions || []));

      return {
        ...(editingId!=null?{id:editingId}:{ }),
        hazardId: parseInt(el('hazardSel').value, 10) || null,
        title:(el('riskTitle').value||'Untitled Hazardous Event').trim(),
        status: el('statusSel').value || 'Tolerate',
        detailsHtml,
        links,
        planActions: actions,
        framework7:{ inputs, rolls, adjs, risks, effs, like, overall, mitigations, gaps, enabled, mitigationSteps: CFG.mitigationSteps },
        narrative: el('narrative').textContent,
        createdAt: new Date().toISOString()
      };
    }
    function saveCurrent(){
      const rec=collectCurrent();
      const op = (editingId!=null) ? SessionStore.put(rec) : SessionStore.add(rec);
      op.then(async ({id})=>{
        editingId = id || editingId;
        refreshHazardsAccordion();
        switchToList();
        await recomputeDirtyAgainstSnapshot();
      }).catch(err=>{ console.error('Save failed', err); alert('Save failed: '+(err?.message||err)); });
    }

    function loadEvent(id){
      SessionStore.get(id).then(r=>{
        if(!r) return;
        editingId=r.id;
        populateHazardSelect(r.hazardId ?? null);
        el('riskTitle').value=r.title||'';
        el('statusSel').value = r.status || 'Tolerate';

        el('descEditor').innerHTML = r.detailsHtml || '';
        setLinks(Array.isArray(r.links)? r.links : []);

        const f=r.framework7||{}; const inputs=f.inputs||{}; const enabled=f.enabled||{};
        CFG.categories.forEach(c=> c.sub.forEach(sf=>{ if(el(sf.id)) el(sf.id).value = inputs[sf.id] ?? 3; }));
        if(el(CFG.likelihoodId)) el(CFG.likelihoodId).value = inputs[CFG.likelihoodId] ?? 3;

        const effs=f.effs||{}; CFG.categories.forEach(c=>{ if(el('eff_'+c.key)) el('eff_'+c.key).value = effs[c.key] ?? 1; });
        const mits=(f.mitigations)||{}; CFG.categories.forEach(c=> setMitigations(c.key, mits[c.key]||[]));
        const gaps=(f.gaps)||{}; CFG.categories.forEach(c=> setGaps(c.key, gaps[c.key]||[]));
        CFG.categories.forEach(c=>{ const chk = el('en_'+c.key); if(chk){ chk.checked = enabled[c.key]===true; toggleSectionBody(c.key, chk.checked); } });

        planActions = Array.isArray(r.planActions) ? r.planActions : [];
        renderActionsList();
        renderPlanGaps();

        CFG.categories.forEach(c=>{
          c.sub.forEach(sf=>{
            if (GUIDANCE[sf.id]) updateGuidanceHighlight(sf.id);
          });
        });
        recalc();
        el('narrative').textContent = r.narrative || el('narrative').textContent;
        activateTab('details');
        switchToEditor();
      });
    }

    // ===== Links helpers =====
    function setLinks(arr){
      const root = el('linksList');
      root.innerHTML = '';
      (arr||[]).forEach((lk, i)=> root.appendChild(renderLinkRow(lk, i)));
    }
    function getLinks(){
      const root = el('linksList');
      return Array.from(root.querySelectorAll('[data-index]')).map(row=>{
        const title = row.querySelector('.font-medium')?.textContent ?? '';
        const desc  = row.querySelector('.text-slate-600')?.textContent ?? '';
        const url   = row.querySelector('a')?.getAttribute('href') ?? '';
        return { title, description: desc, url };
      });
    }
    function renderLinkRow(link, idx){
      const row = document.createElement('div');
      row.className = 'border rounded-xl p-3 bg-white flex items-start justify-between gap-3';
      row.setAttribute('data-index', String(idx));
      row.innerHTML = `
        <div class="min-w-0">
          <div class="font-medium truncate">${escapeHtml(link.title||'(untitled)')}</div>
          <div class="text-sm text-slate-600 line-clamp-2">${escapeHtml(link.description||'')}</div>
          <a href="${escapeHtml(link.url||'#')}" target="_blank" class="text-sm text-violet-700 underline break-all">${escapeHtml(link.url||'')}</a>
        </div>
        <div class="flex gap-2 shrink-0">
          <button class="px-2 py-1 rounded-lg border text-sm" data-role="edit">Edit</button>
          <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 text-sm" data-role="remove">Remove</button>
        </div>
      `;
      row.querySelector('[data-role="edit"]').addEventListener('click', (e)=>{ e.stopPropagation(); openLinkModal('Edit Link', idx); markDirtySoon(); });
      row.querySelector('[data-role="remove"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!confirm('Remove this link?')) return;
        const arr = getLinks();
        arr.splice(idx,1);
        setLinks(arr);
        markDirtySoon();
      });
      return row;
    }
    function openLinkModal(title, idx=null){
      el('linkModalTitle').textContent = title || 'Add Link';
      const isEdit = (idx!==null && idx!==undefined);
      const arr = getLinks();
      const existing = isEdit ? arr[idx] : { title:'', description:'', url:'' };
      el('linkTitleInput').value = existing.title || '';
      el('linkDescInput').value  = existing.description || '';
      el('linkUrlInput').value   = existing.url || '';
      el('linkModal').classList.remove('hidden'); el('linkModal').classList.add('flex');

      el('linkOkBtn').onclick = ()=>{
        const t = el('linkTitleInput').value.trim();
        const d = el('linkDescInput').value.trim();
        const u = el('linkUrlInput').value.trim();
        const link = { title:t, description:d, url:u };
        if(isEdit) { const a = getLinks(); a[idx] = link; setLinks(a); }
        else { const a = getLinks(); a.push(link); setLinks(a); }
        closeLinkModal(); markDirtySoon();
      };
      el('linkCancelBtn').onclick = closeLinkModal;
    }
    function closeLinkModal(){
      el('linkModal').classList.add('hidden'); el('linkModal').classList.remove('flex');
      el('linkOkBtn').onclick = null; el('linkCancelBtn').onclick = null;
    }

    // ===== Plan: gaps + actions =====
    let planActions = [];
    let editingActionIndex = null;

    function gapKey(catKey, title, details){
      return `${catKey}|${(title||'').trim().toLowerCase()}|${(details||'').trim().toLowerCase()}`;
    }
    function getAllGapsFromUI(){
      const out = [];
      CFG.categories.forEach(c=>{
        getGaps(c.key).forEach(g=>{
          const key = gapKey(c.key, g.title, g.details);
          out.push({ key, catKey: c.key, title: g.title||'', details: g.details||'' });
        });
      });
      return out;
    }
    function getAddressedKeys(tempSelectedKeys = new Set()){
      const keys = new Set();
      planActions.forEach(a=> (a.gaps||[]).forEach(g=> keys.add(g.key)));
      tempSelectedKeys.forEach(k=> keys.add(k));
      return keys;
    }

function renderPlanGaps(tempSelectedKeys){
  // Build a fast lookup for "addressed" gaps, including temporary selections from the Action modal
  const addressedKeys = getAddressedKeys(tempSelectedKeys || new Set());

  // Gather all gaps from UI with their Risk Group
  const byGroup = new Map(); // catKey -> { cat, addressed:[], unaddressed:[] }
  CFG.categories.forEach(cat => {
    const gaps = getGaps(cat.key); // [{title, details}]
    if (!gaps.length) return;

    const bucket = { cat, addressed: [], unaddressed: [] };

    gaps.forEach(g => {
      const key = gapKey(cat.key, g.title, g.details);
      const chip = `<span class="pill ${addressedKeys.has(key) ? 'pill-amber' : 'pill-red'}" title="${escapeHtml(g.details||'')}">${escapeHtml(g.title||'(gap)')}</span>`;
      if (addressedKeys.has(key)) bucket.addressed.push(chip);
      else bucket.unaddressed.push(chip);
    });

    byGroup.set(cat.key, bucket);
  });

  const root = el('plan_gaps_by_group');
  if (!byGroup.size) {
    root.innerHTML = `<div class="text-sm text-slate-500">No gaps defined yet. Add gaps in the Community Risk tab.</div>`;
    return;
  }

  // Render each Risk Group row with three columns:
  // [Risk Group] | [Addressed by Actions] | [Not Addressed Yet]
  const rows = [];
  byGroup.forEach(({ cat, addressed, unaddressed }) => {
    rows.push(`
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 p-3 rounded-xl bg-white border">
        <div class="md:col-span-1">
          <div class="text-sm text-slate-500 mb-1">Risk Group</div>
          <div class="font-medium">${escapeHtml(cat.title)}</div>
        </div>
        <div>
          <div class="text-sm text-slate-600 mb-1">Addressed by Actions</div>
          <div class="flex flex-wrap gap-2">${addressed.join('') || '<span class="text-slate-400 text-sm">None</span>'}</div>
        </div>
        <div>
          <div class="text-sm text-slate-600 mb-1">Not Addressed Yet</div>
          <div class="flex flex-wrap gap-2">${unaddressed.join('') || '<span class="text-slate-400 text-sm">None</span>'}</div>
        </div>
      </div>
    `);
  });

  root.innerHTML = rows.join('');
}


    function renderActionsList(){
      const root = el('actionsList');
      if(!planActions.length){
        root.innerHTML = `<div class="text-sm text-slate-500">No actions yet. Click <strong>+ Add Action</strong> to create one.</div>`;
        return;
      }
      root.innerHTML = planActions.map((a,idx)=>{
        const dateStr = [a.start||'', a.end||''].filter(Boolean).join(' → ');
        const gapBadges = (a.gaps||[]).map(g=> `<span class="pill pill-amber">${escapeHtml(g.title||'(gap)')}</span>`).join(' ');
        return `
          <div class="border rounded-xl p-3 bg-white flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="font-medium">${escapeHtml(a.title||'(untitled action)')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(dateStr||'')}</div>
            </div>
            <div class="text-sm text-slate-700 whitespace-pre-line">${escapeHtml(a.outline||'')}</div>
            <div class="flex flex-wrap gap-2">${gapBadges}</div>
            <div class="flex gap-2 justify-end">
              <button class="px-2 py-1 rounded-lg border text-sm" data-role="edit" data-index="${idx}">Edit</button>
              <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 text-sm" data-role="del" data-index="${idx}">Delete</button>
            </div>
          </div>
        `;
      }).join('');

      root.querySelectorAll('[data-role="edit"]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); openActionModal(Number(btn.getAttribute('data-index'))); markDirtySoon(); });
      });
      root.querySelectorAll('[data-role="del"]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const i = Number(btn.getAttribute('data-index'));
          if(!confirm('Delete this action?')) return;
          planActions.splice(i,1);
          renderActionsList();
          renderPlanGaps();
          markDirtySoon();
        });
      });
    }

    function openActionModal(index=null){
      editingActionIndex = (index!=null ? index : null);
      const allGaps = getAllGapsFromUI();

      if(index==null){
        el('actionModalTitle').textContent = 'Add Action';
        el('actionTitleInput').value = '';
        el('actionOutlineInput').value = '';
        el('actionStartInput').value = '';
        el('actionEndInput').value   = '';
      } else {
        const a = planActions[index];
        el('actionModalTitle').textContent = 'Edit Action';
        el('actionTitleInput').value = a.title || '';
        el('actionOutlineInput').value = a.outline || '';
        el('actionStartInput').value = a.start || '';
        el('actionEndInput').value   = a.end   || '';
      }

      const selectedKeys = new Set(index==null ? [] : (planActions[index].gaps||[]).map(g=> g.key));
      const picker = el('actionGapPicker');
picker.innerHTML = allGaps.map(g=>{
  const pressed = selectedKeys.has(g.key) ? 'true' : 'false';
  // start visually muted; refreshPickerColours() will set amber/red as needed
  return `<button type="button" class="gap-pill pill pill-muted"
            aria-pressed="${pressed}"
            data-key="${g.key}"
            title="${escapeHtml(g.details||'')}">${escapeHtml(g.title||'(gap)')}</button>`;
}).join('') || '<div class="text-sm text-slate-500">No gaps defined in Community Risk tab.</div>';

      function currentTempSet(){
        return new Set(Array.from(picker.querySelectorAll('.gap-pill[aria-pressed="true"]')).map(b=> b.getAttribute('data-key')));
      }
      function refreshPickerColours(){
        const temp = currentTempSet();
        const addressed = getAddressedKeys(temp);

        picker.querySelectorAll('.gap-pill').forEach(btn=>{
          const k = btn.getAttribute('data-key');
          const on = btn.getAttribute('aria-pressed') === 'true';
          btn.classList.remove('pill-red','pill-amber','pill-muted');
          if(!on){
            btn.classList.add('pill-muted');
          } else {
            if(addressed.has(k)) btn.classList.add('pill-amber');
            else btn.classList.add('pill-red');
          }
        });

        renderPlanGaps(temp);
      }

      picker.querySelectorAll('.gap-pill').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const now = btn.getAttribute('aria-pressed') === 'true';
          btn.setAttribute('aria-pressed', now ? 'false' : 'true');
          refreshPickerColours();
        });
      });

      refreshPickerColours();
      el('actionModal').classList.remove('hidden'); el('actionModal').classList.add('flex');

      el('actionOkBtn').onclick = ()=>{
        const title   = el('actionTitleInput').value.trim();
        const outline = el('actionOutlineInput').value.trim();
        const start   = el('actionStartInput').value;
        const end     = el('actionEndInput').value;

        const temp = currentTempSet();
        const selected = Array.from(temp).map(key=>{
          const g = allGaps.find(x=> x.key===key);
          return { key, catKey: g?.catKey || '', title: g?.title || '', details: g?.details || '' };
        });

        const actionObj = { id: (editingActionIndex!=null? planActions[editingActionIndex].id : Date.now()),
                            title, outline, start, end, gaps: selected };

        if(editingActionIndex==null) planActions.push(actionObj);
        else planActions[editingActionIndex] = actionObj;

        renderActionsList();
        renderPlanGaps();
        closeActionModal();
        markDirtySoon();
      };
      el('actionCancelBtn').onclick = closeActionModal;
    }
    function closeActionModal(){
      el('actionModal').classList.add('hidden'); el('actionModal').classList.remove('flex');
      el('actionOkBtn').onclick = null; el('actionCancelBtn').onclick = null;
    }

    // ===== Hazard list =====
      
      function buildEventRowsHTML(rows){
  return rows.map(r=>{
    const f = r.framework7 || {};
    const overall = Number(f.overall ?? 0);
    const rc = riskClass(overall);
    const status = r.status || 'Tolerate';
    const badge = `<span class="inline-block text-xs ${rc.cls} px-2 py-0.5 rounded-full">${rc.label}</span>`;
    return `<tr class="border-b hover:bg-slate-50" data-id="${r.id}">
      <td class="py-2 pr-4">${escapeHtml(r.title||'')}</td>
      <td class="py-2 pr-4"><div class="flex items-center gap-2"><span class="font-semibold">${overall.toFixed(1)}</span>${badge}</div></td>
      <td class="py-2 pr-4">${escapeHtml(status)}</td>
      <td class="py-2 pr-4">
        <button data-action="edit" data-id="${r.id}" class="px-2 py-1 rounded-lg border mr-1">Edit</button>
        <button data-action="dup"  data-id="${r.id}" class="px-2 py-1 rounded-lg border mr-1">Duplicate</button>
        <button data-action="del"  data-id="${r.id}" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700">Delete</button>
      </td>
    </tr>`;
  }).join('');
}


      function hazardBlock(h, rows, isUncat=false){
        const count = rows.length;
        const subtitle = `${isUncat ? 'Uncategorised' : 'Hazard'} • ${count} event${count===1?'':'s'}`;
        const hazIdAttr = (h.id===null ? 'null' : String(h.id));
        const headerActions = isUncat
          ? ''
          : `<div class="flex gap-2">
               <button data-action="haz-rename" data-id="${hazIdAttr}" class="px-2 py-1 rounded-lg border">Rename</button>
               <button data-action="haz-delete" data-id="${hazIdAttr}" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700">Delete</button>
             </div>`;

        // 🔽 use global sort for event rows
        const rowsSorted = sortEvents(rows || []);

        const tableRows = buildEventRowsHTML(rowsSorted);

        return `
        <details class="rounded-xl border">
          <summary class="cursor-pointer select-none flex items-center justify-between p-4">
            <div class="flex items-center gap-3">
              <svg class="chev transition-transform" width="16" height="16" viewBox="0 0 20 20"><path fill="currentColor" d="M7 5l6 5-6 5V5z"/></svg>
              <div>
                <div class="font-semibold">${escapeHtml(h.title || 'Untitled Hazard')}</div>
                <div class="text-sm text-slate-500">${subtitle}</div>
              </div>
            </div>
            ${headerActions}
          </summary>
          <div class="p-4 pt-0">
            <div class="overflow-x-auto mt-3">
              <table class="min-w-full text-sm" data-hazard="${hazIdAttr}">
                <thead>
                  <tr class="text-left">
                    <th class="py-2 pr-4">
                      <button class="th-sort font-semibold" data-sort="title" type="button">
                        Event Title${sortIcon('title')}
                      </button>
                    </th>
                    <th class="py-2 pr-4">
                      <button class="th-sort font-semibold" data-sort="score" type="button">
                        Risk Score${sortIcon('score')}
                      </button>
                    </th>
                    <th class="py-2 pr-4">
                      <button class="th-sort font-semibold" data-sort="status" type="button">
                        Status${sortIcon('status')}
                      </button>
                    </th>
                    <th class="py-2 pr-4">Actions</th>
                  </tr>
                </thead>
                <tbody>${tableRows || ''}</tbody>
              </table>
            </div>
          </div>
        </details>`;
      }
      
      function updateAriaSort(root){
  // reset all headers
  root.querySelectorAll('table thead th').forEach(th=>{
    th.setAttribute('aria-sort', 'none');
  });

  // set the active one based on EVENT_SORT
  root.querySelectorAll('.th-sort').forEach(btn=>{
    const key = btn.getAttribute('data-sort');
    const th = btn.closest('th');
    if(!th) return;
    th.setAttribute(
      'aria-sort',
      EVENT_SORT.key === key
        ? (EVENT_SORT.dir === 'asc' ? 'ascending' : 'descending')
        : 'none'
    );
  });
}

      
      function wireRowActions(root){
  root.querySelectorAll('tbody tr').forEach(tr=>{
    tr.addEventListener('click',(e)=>{
      const actionBtn = e.target.closest('button');
      if(actionBtn){
        const act = actionBtn.dataset.action;
        const id = Number(actionBtn.dataset.id);
        if(act==='del'){ e.stopPropagation(); SessionStore.delete(id).then(async ()=>{ resortAllTablesInPlace(); await recomputeDirtyAgainstSnapshot(); }); return; }
        if(act==='dup'){ e.stopPropagation(); duplicateEvent(id); return; }
        if(act==='edit'){ e.stopPropagation(); loadEvent(id); return; }
      } else {
        const id=Number(tr.dataset.id); if(id) loadEvent(id);
      }
    });
  });
}


      
function renderHazardsAccordion(hazards, items){
  const root = el('hazardsAccordion');
  if(!hazards.length && !items.length){
    root.innerHTML = `<div class="text-slate-500">No Hazards or Hazardous Events yet. Use <strong>Add Hazard</strong> or <strong>Add Hazardous Event</strong> to begin.</div>`;
    updateAriaSort(root);
    return;
  }

  // 🔽 hazards A→Z
  const hazardsAZ = sortHazardsByTitle(hazards);

  const byHaz = new Map();
  hazardsAZ.forEach(h=> byHaz.set(h.id, []));
  const uncategorised = [];
  items.forEach(ev=>{
    if(ev.hazardId && byHaz.has(ev.hazardId)) byHaz.get(ev.hazardId).push(ev);
    else uncategorised.push(ev);
  });

  // Build blocks in A→Z, then Uncategorised last
  const blocks = [];
  hazardsAZ.forEach(h=>{ blocks.push(hazardBlock(h, byHaz.get(h.id) || [])); });
  blocks.push(hazardBlock({ id:null, title:'Uncategorised' }, uncategorised, true));

  root.innerHTML = blocks.join('');
  updateSortIndicators(root);
updateAriaSort(root);
  
  root.querySelectorAll('table[data-hazard]').forEach(tbl => wireRowActions(tbl));


  // Row actions (unchanged)
  root.querySelectorAll('table[data-hazard] tbody tr').forEach(tr=>{
    tr.addEventListener('click',(e)=>{
      const actionBtn = e.target.closest('button');
      if(actionBtn){
        const act = actionBtn.dataset.action;
        const id = Number(actionBtn.dataset.id);
        if(act==='del'){ e.stopPropagation(); SessionStore.delete(id).then(async ()=>{ refreshHazardsAccordion(); await recomputeDirtyAgainstSnapshot(); }); return; }
        if(act==='dup'){ e.stopPropagation(); duplicateEvent(id); return; }
        if(act==='edit'){ e.stopPropagation(); loadEvent(id); return; }
      } else {
        const id=Number(tr.dataset.id); if(id) loadEvent(id);
      }
    });
  });

  // 🔽 Header clicks apply global sort across ALL groups
// Header clicks: global sort, in-place update, keep accordion open
root.querySelectorAll('.th-sort').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.preventDefault();     // don't do anything "buttony"
    e.stopPropagation();    // don't toggle the <summary>/<details>

    const key = btn.getAttribute('data-sort');
    if (EVENT_SORT.key === key){
      EVENT_SORT.dir = (EVENT_SORT.dir === 'asc' ? 'desc' : 'asc');
    } else {
      EVENT_SORT.key = key;
      EVENT_SORT.dir = (key === 'score' ? 'desc' : 'asc'); // your sensible default
    }

    updateSortIndicators(root);   // refresh header arrows across all tables
    resortAllTablesInPlace();     // fade/swap rows only
  });
});


  // Hazard header buttons (unchanged)
  root.querySelectorAll('[data-action="haz-rename"]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const hid = btn.dataset.id==='null' ? null : Number(btn.dataset.id);
      if(hid===null){ alert('Cannot rename the Uncategorised group.'); return; }
      SessionStore.getAllHazards().then(hzs=>{
        const hz = hzs.find(z=> z.id===hid);
        if(!hz) return;
        const t = prompt('Rename hazard:', hz.title);
        if(t && t.trim()){
          SessionStore.putHazard({ id:hid, title:t.trim() }).then(async ()=>{ refreshHazardsAccordion(); await recomputeDirtyAgainstSnapshot(); });
        }
      });
    });
  });
  root.querySelectorAll('[data-action="haz-delete"]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      const hid = btn.dataset.id==='null' ? null : Number(btn.dataset.id);
      if(hid===null){ alert('Uncategorised cannot be deleted.'); return; }
      if(!confirm('Delete this hazard? All associated events will be moved to Uncategorised.')) return;
      SessionStore.deleteHazard(hid).then(async ()=>{ refreshHazardsAccordion(); await recomputeDirtyAgainstSnapshot(); });
    });
  });
}

async function renderListView(){
  const [hazards, items] = await Promise.all([SessionStore.getAllHazards(), SessionStore.getAll()]);
  const filtered = filterItemsBySearch(items);

  if (LIST_VIEW_MODE === 'grouped'){
    renderHazardsAccordion(hazards, filtered);  // you already have this
    updateSortIndicators(document.getElementById('hazardsAccordion'));
    updateAriaSort(document.getElementById('hazardsAccordion'));
  } else {
    renderAllEventsTable(filtered);
  }
}

function refreshHazardsAccordion(){ // keep name for compatibility with your calls
  // delegate to the new smarter renderer
  renderListView();
}

    function duplicateEvent(id){
      SessionStore.get(id).then(r=>{
        if(!r) return;
        const { id:_omit, createdAt:__omit, ...rest } = r;
        const copy={ ...rest, title: r.title+' (copy)', createdAt: new Date().toISOString() };
        return SessionStore.add(copy);
      }).then(async ()=>{ refreshHazardsAccordion(); await recomputeDirtyAgainstSnapshot(); })
        .catch(err=>{ console.error('Duplicate failed', err); alert('Duplicate failed: '+(err?.message||err)); });
    }

    // ===== Hazard select =====
function populateHazardSelect(selectedId){
  SessionStore.getAllHazards().then(hazards=>{
    const hazardsAZ = sortHazardsByTitle(hazards); // 👈 reuse your helper
    const sel = el('hazardSel');
    const options = [
      `<option value="">(Uncategorised)</option>`,
      ...hazardsAZ.map(h=> `<option value="${h.id}">${escapeHtml(h.title)}</option>`)
    ];
    sel.innerHTML = options.join('');
    if (selectedId!=null && hazardsAZ.some(h=> h.id===selectedId)) sel.value=String(selectedId);
    else if (editingHazardId!=null && hazardsAZ.some(h=> h.id===editingHazardId)) sel.value=String(editingHazardId);
    else sel.value='';
  });
}


    // ===== View switching & tabs =====
    function switchToList(){
      el('listView').classList.remove('hidden');
      el('editorView').classList.add('hidden');
      editingId=null;
    }
    function switchToEditor(){
      el('listView').classList.add('hidden');
      el('editorView').classList.remove('hidden');
    }
    function toggleSectionBody(key, on){
      const body = el('sec_'+key+'_body');
      if(!body) return;
      body.classList.toggle('hidden', !on);
    }

    function activateTab(name){
      const panels = {
        details: el('tab_details'),
        risk: el('tab_risk'),
        plan: el('tab_plan')
      };
      const buttons = Array.from(document.querySelectorAll('[data-tab]'));
      buttons.forEach(b=>{
        if(b.dataset.tab===name){
          b.classList.add('tab-btn-active'); b.classList.remove('tab-btn-inactive');
        } else {
          b.classList.remove('tab-btn-active'); b.classList.add('tab-btn-inactive');
        }
      });
      Object.entries(panels).forEach(([k, panel])=>{
        if(panel) panel.classList.toggle('active', k===name);
      });

      if(name==='plan'){
        renderPlanGaps();
        renderActionsList();
      }
    }
    function wireTabs(){
      document.querySelectorAll('[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=> activateTab(btn.dataset.tab));
      });
      activateTab('details');
    }

    // ===== RTE =====
    function exec(cmd, val=null){ document.execCommand(cmd, false, val); el('descEditor').focus(); markDirtySoon(); }
    function wireRte(){
      const tb = document.querySelector('.rte-toolbar');
      if(!tb) return;
      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.hasAttribute('data-cmd')) exec(btn.getAttribute('data-cmd'));
        else if(btn.hasAttribute('data-link')){
          const url = prompt('Enter URL (https://…):');
          if(url) exec('createLink', url);
        } else if(btn.hasAttribute('data-clear')) {
          if(confirm('Clear description?')) { el('descEditor').innerHTML = ''; markDirtySoon(); }
        }
      });
      el('descEditor').addEventListener('input', markDirtySoon);
    }
      
      function updateSortIndicators(root){
  root.querySelectorAll('table thead .th-sort').forEach(btn=>{
    const key = btn.getAttribute('data-sort');
    // cache the base label once (strip any existing arrow)
    const base = btn.dataset.baseLabel || btn.textContent.replace(/[▲▼]\s*$/,'').trim();
    btn.dataset.baseLabel = base;
    let suffix = '';
    if (EVENT_SORT.key === key) suffix = (EVENT_SORT.dir === 'asc' ? ' ▲' : ' ▼');
    btn.textContent = base + suffix;
  });
}


    // ===== Dirty helpers (mark dataset potentially unsaved) =====
    let markDirtyTimer = null;
    function markDirty(){ fileDirty = true; refreshStatus(); }
    function markDirtySoon(){ clearTimeout(markDirtyTimer); markDirtyTimer = setTimeout(markDirty, 150); }

    // ===== File helpers (.litl) =====
    function createLitlBlob(items, hazards){
      const litl = {
        litlVersion: 1,
        appId: 'crr-v1',
        title: 'Community Risk Register',
        data: { items, hazards }
      };
      return new Blob([JSON.stringify(litl, null, 2)], { type: 'application/x-litl' });
    }

    async function openLitlWithPicker(){
      const [handle] = await window.showOpenFilePicker({
        multiple: false,
        types: [{ description: 'litl files', accept: { 'application/x-litl': ['.litl'] } }]
      });
      currentFileHandle = handle;
      currentFileName = handle.name || 'untitled.litl';
      const file = await handle.getFile();
      const text = await file.text();
      const data = JSON.parse(text);

      const payload = data?.data
        ? { items: Array.isArray(data.data.items)?data.data.items:[], hazards: Array.isArray(data.data.hazards)?data.data.hazards:[] }
        : { items: Array.isArray(data.items)?data.items:[], hazards: Array.isArray(data.hazards)?data.hazards:[] };

      SessionStore.setAll(payload);
      refreshHazardsAccordion();
      switchToList();
      await updateSavedSnapshot();
      updateFileMenuState();
    }
    function openLitlWithInput(file){
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const json = JSON.parse(reader.result);
          const payload = json?.data
            ? { items: Array.isArray(json.data.items)?json.data.items:[], hazards: Array.isArray(json.data.hazards)?json.data.hazards:[] }
            : { items: Array.isArray(json.items)?json.items:[], hazards: Array.isArray(json.hazards)?json.hazards:[] };
          currentFileHandle = null; // cannot overwrite via input
          currentFileName = file.name || 'loaded.litl';
          SessionStore.setAll(payload);
          refreshHazardsAccordion();
          switchToList();
          await updateSavedSnapshot();
          updateFileMenuState();
        } catch(err){
          console.error(err);
          alert('Invalid .litl file.');
        }
      };
      reader.readAsText(file);
    }
    async function saveLitl(){
      try{
        saving = true; refreshStatus();
        const [items, hazards] = await Promise.all([SessionStore.getAll(), SessionStore.getAllHazards()]);
        const blob = createLitlBlob(items, hazards);

        if (canSave()) {
          const writable = await currentFileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          await updateSavedSnapshot();
          saving = false; refreshStatus();
          return;
        }
        await saveLitlAs();
        saving = false; refreshStatus();
      }catch(err){
        console.error('Save .litl failed', err);
        saving = false; refreshStatus();
        alert('Save failed: '+(err?.message||err));
      }
    }
    async function saveLitlAs(){
      try{
        saving = true; refreshStatus();
        const [items, hazards] = await Promise.all([SessionStore.getAll(), SessionStore.getAllHazards()]);
        const blob = createLitlBlob(items, hazards);

        if (window.showSaveFilePicker) {
          const handle = await window.showSaveFilePicker({
            suggestedName: currentFileName || 'community_risk_register.litl',
            types: [{ description: 'litl files', accept: { 'application/x-litl': ['.litl'] } }]
          });
          currentFileHandle = handle;
          currentFileName = handle.name || 'community_risk_register.litl';
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
          await updateSavedSnapshot();
          updateFileMenuState();
          saving = false; refreshStatus();
          return;
        }

        // Fallback download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = currentFileName || 'community_risk_register.litl';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
        if (!currentFileName) currentFileName = 'community_risk_register.litl';
        await updateSavedSnapshot();
        updateFileMenuState();
        saving = false; refreshStatus();
      }catch(err){
        console.error('Save As .litl failed', err);
        saving = false; refreshStatus();
        alert('Save As failed: '+(err?.message||err));
      }
    }
    function newRegister(){
      SessionStore.setAll({ items: [], hazards: [] });
      currentFileHandle = null;
      currentFileName = null;
      refreshHazardsAccordion();
      switchToList();
      lastSavedSnapshot = '';
      fileDirty = true;
      updateFileMenuState();
      refreshStatus();
    }

    // ===== File menu wiring & keyboard shortcuts =====
    function wireFileMenu(){
      const root = document.getElementById('fileMenuRoot');
      const btn  = document.getElementById('fileMenuBtn');
      const panel= document.getElementById('fileMenuPanel');
      const openInput = document.getElementById('openLitlInput');

      function closeMenu(){ root.classList.remove('menu-open'); panel.classList.add('hidden'); }
      function openMenu(){ root.classList.add('menu-open'); panel.classList.remove('hidden'); }
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); if(root.classList.contains('menu-open')) closeMenu(); else openMenu(); });
      document.addEventListener('click', closeMenu);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

      document.getElementById('menuNew').addEventListener('click', ()=> { closeMenu(); newRegister(); });
      document.getElementById('menuOpen').addEventListener('click', async ()=> {
        closeMenu();
        try{
          if (window.showOpenFilePicker) await openLitlWithPicker();
          else openInput.click();
        }catch(err){
          if (err?.name !== 'AbortError') { console.error(err); }
        }
      });
      openInput.addEventListener('change', (e)=>{
        const f = e.target.files?.[0];
        if(f) openLitlWithInput(f);
        e.target.value='';
      });

      document.getElementById('menuSave').addEventListener('click', async ()=>{ closeMenu(); await saveLitl(); });
      document.getElementById('menuSaveAs').addEventListener('click', async ()=>{ closeMenu(); await saveLitlAs(); });

      // Ctrl+S / Ctrl+O / Ctrl+N
      document.addEventListener('keydown', (e)=>{
        const ctrl = e.ctrlKey || e.metaKey;
        if(ctrl && e.key.toLowerCase()==='s'){ e.preventDefault(); saveLitl(); }
        if(ctrl && e.key.toLowerCase()==='o'){ e.preventDefault(); if (window.showOpenFilePicker) openLitlWithPicker(); else openInput.click(); }
        if(ctrl && e.key.toLowerCase()==='n'){ e.preventDefault(); newRegister(); }
      });

      updateFileMenuState();
    }

    // ===== Wire page =====
    function wire(){
      buildCategoryBlocks();
      wireTabs();
      wireRte();
      wireFileMenu();

      // Gaps/Mitigations add
      CFG.categories.forEach(c=>{
        const mitAdd = el(`mit_${c.key}_add`);
        const mitInp = el(`mit_${c.key}_input`);
        if (mitAdd) {
          mitAdd.addEventListener('click', ()=>{ const t = (mitInp?.value||'').trim(); if(!t) return; addTag('mit', c.key, t, ''); mitInp.value = ''; });
        }
        if (mitInp) mitInp.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); mitAdd?.click(); }});

        const gapAdd = el(`gap_${c.key}_add`);
        const gapInp = el(`gap_${c.key}_input`);
        if (gapAdd) {
          gapAdd.addEventListener('click', ()=>{ const t = (gapInp?.value||'').trim(); if(!t) return; addTag('gap', c.key, t, ''); gapInp.value = ''; });
        }
        if (gapInp) gapInp.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); gapAdd?.click(); }});

        const chk = el('en_'+c.key);
        if(chk) chk.addEventListener('change', ()=>{ toggleSectionBody(c.key, chk.checked); recalc(); renderPlanGaps(); markDirtySoon(); });
      });

      // Score inputs
      CFG.categories.forEach(c=> c.sub.forEach(sf=>{
        const inp = el(sf.id);
        inp.addEventListener('input', ()=>{ recalc(); markDirtySoon(); });
        if (GUIDANCE[sf.id]) {
          const panelId = 'g_'+sf.id;
          inp.addEventListener('focus', ()=>{ showGuide(panelId); updateGuidanceHighlight(sf.id); });
          inp.addEventListener('input', ()=> updateGuidanceHighlight(sf.id));
          inp.addEventListener('change', ()=> updateGuidanceHighlight(sf.id));
          inp.addEventListener('blur', ()=> hideGuide(panelId));
        }
      }));
      el(CFG.likelihoodId).addEventListener('input', ()=>{ recalc(); markDirtySoon(); });
      CFG.categories.forEach(c=> el('eff_'+c.key).addEventListener('input', ()=>{ recalc(); markDirtySoon(); }));

      // Buttons
      el('addHazardBtn').addEventListener('click', ()=>{
        const t = prompt('New hazard title:');
        if(!t || !t.trim()) return;
        SessionStore.addHazard(t.trim()).then(async ()=>{
          refreshHazardsAccordion();
          await recomputeDirtyAgainstSnapshot();
          populateHazardSelect(editingHazardId);
        });
      });

      el('addEventBtn').addEventListener('click', ()=>{
        editingId=null; el('riskTitle').value=''; el('statusSel').value='Tolerate';
        el('descEditor').innerHTML = ''; setLinks([]);
        CFG.categories.forEach(c=>{
          c.sub.forEach(sf=> el(sf.id).value=3 );
          if(el('eff_'+c.key)) el('eff_'+c.key).value=1;
          setMitigations(c.key, []); setGaps(c.key, []);
          const chk=el('en_'+c.key); if(chk){ chk.checked=false; toggleSectionBody(c.key, false); }
        });
        el(CFG.likelihoodId).value=3; recalc();
        el('narrative').textContent='Press Generate Narrative to produce a tailored summary.';
        populateHazardSelect(editingHazardId);
        planActions = []; renderActionsList(); renderPlanGaps();
        activateTab('details');
        switchToEditor();
      });

      el('addActionBtn').addEventListener('click', ()=> openActionModal(null));

      el('generateBtn').addEventListener('click', genNarrative);
      el('saveBtn').addEventListener('click', async ()=>{ saveCurrent(); await recomputeDirtyAgainstSnapshot(); });
      el('backToListBtn').addEventListener('click', ()=> switchToList());
      el('cancelBtn').addEventListener('click', ()=> switchToList());
      el('resetBtn').addEventListener('click', ()=>{ if(!editingId) return; loadEvent(editingId); });

    // Open the "Add Link" modal from the Details tab
    const addLinkBtn = el('addLinkBtn');
    if (addLinkBtn) addLinkBtn.addEventListener('click', () => openLinkModal('Add Link'));
      
      // Tabs for list view
document.querySelectorAll('[data-listtab]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    LIST_VIEW_MODE = btn.getAttribute('data-listtab');   // 'grouped' | 'all'
    updateListTabsUI();
    renderListView();
  });
});

// Search box — live filter; switches to "All" when typing
const searchEl = document.getElementById('listSearch');
const clearEl  = document.getElementById('listSearchClear');

function applySearch(){
  LIST_SEARCH = searchEl.value || '';
  if (LIST_SEARCH.trim()){
    LIST_VIEW_MODE = 'all';          // auto switch to All
    updateListTabsUI();
  }
  renderListView();
}

searchEl.addEventListener('input', applySearch);
clearEl.addEventListener('click', ()=>{
  searchEl.value = '';
  LIST_SEARCH = '';
  applySearch();
});



      refreshHazardsAccordion();
      switchToList();
      recalc();
      refreshStatus();
      importFromHash();
    }
    
    async function resortAllTablesInPlace(){
  const [hazards, items] = await Promise.all([SessionStore.getAllHazards(), SessionStore.getAll()]);
  const hazardsAZ = sortHazardsByTitle(hazards);

  // bucket events by hazard
  const byHaz = new Map();
  hazardsAZ.forEach(h=> byHaz.set(h.id, []));
  const uncategorised = [];
  items.forEach(ev=>{
    if(ev.hazardId && byHaz.has(ev.hazardId)) byHaz.get(ev.hazardId).push(ev);
    else uncategorised.push(ev);
  });

  // update each table body in place (no accordion rebuild)
  document.querySelectorAll('#hazardsAccordion table[data-hazard]').forEach(tbl=>{
    const hidAttr = tbl.getAttribute('data-hazard');
    const rows = (hidAttr==='null')
      ? uncategorised
      : byHaz.get(Number(hidAttr)) || [];
    const sorted = sortEvents(rows);
    const tbody = tbl.querySelector('tbody');
    if(!tbody) return;

    // fade out → swap → fade in
    tbody.classList.add('tbody-fade');
    tbody.style.opacity = '0';
    setTimeout(()=>{
      tbody.innerHTML = buildEventRowsHTML(sorted);
      wireRowActions(tbl);          // rebind row buttons in this tbody
      tbody.style.opacity = '1';
    }, 180);

    // update aria-sort on headers
    updateAriaSort(tbl.closest('#hazardsAccordion') || document);
  });
}


    // Warn on unload if unsaved
    window.addEventListener('beforeunload', (e)=>{
      if (fileDirty) { e.preventDefault(); e.returnValue = ''; }
    });

    // Boot
    wire();
  </script>
</body>
</html>
