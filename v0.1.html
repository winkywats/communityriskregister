<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Risk Register - Single Page Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .2s; border-radius: 9999px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 9999px; }
    .switch input:checked + .slider { background-color: #16a34a; }
    .switch input:checked + .slider:before { transform: translateX(20px); }
    #radarChart { width: 100%; height: 300px; display: block; }
    details[open] summary .chev { transform: rotate(90deg); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-6">

    <header class="mb-6">
      <h1 class="text-3xl font-bold">Community Risk Register - Demo</h1>
      <p class="text-slate-600 mb-3">
        Manage <strong>Hazards</strong> and their <strong>Hazardous Events</strong>. Enter scores (1–5) across the seven NFCC-aligned dimensions. We'll roll them up and auto-generate a narrative.
      </p>
      <div class="flex flex-wrap items-center gap-3">
        <button id="addHazardBtn" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-medium">Add Hazard</button>
        <button id="addEventBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Add Hazardous Event</button>
        <button id="copyLinkBtn" class="px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white font-medium">Copy Saved Link</button>
        <button id="saveAsBtn" class="px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-700 text-white font-medium">Save As…</button>
      </div>
    </header>

    <!-- Hazards + Events List (Accordion) -->
    <section id="listView" class="mb-6">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Hazards</h2>
          <div class="text-sm text-slate-500">Expand a hazard to view and edit its hazardous events</div>
        </div>

        <div id="hazardsAccordion" class="space-y-3">
          <!-- dynamically rendered -->
        </div>
      </div>
    </section>

    <!-- Editor view (single Hazardous Event) -->
    <div id="editorView" class="grid lg:grid-cols-3 gap-6 hidden">
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow p-5 space-y-6">
          <!-- Title + Hazard selection -->
          <div class="flex flex-col gap-3">
            <div class="flex items-center gap-3">
              <label for="riskTitle" class="font-semibold w-40">Event Title</label>
              <input id="riskTitle" type="text" placeholder="e.g., Dwelling Fire, RTC, Flooding"
                     class="flex-1 px-3 py-2 rounded-xl border" />
            </div>
            <div class="flex items-center gap-3">
              <label for="hazardSel" class="font-semibold w-40">Associated Hazard</label>
              <select id="hazardSel" class="px-3 py-2 rounded-xl border min-w-[16rem]"></select>
              <button id="cancelBtn" class="ml-auto px-3 py-2 rounded-xl border">Cancel</button>
              <button id="backToListBtn" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-700 text-white">Back to List</button>
              <button id="resetBtn" class="px-3 py-2 rounded-xl border">Reset</button>
            </div>
          </div>

          <!-- categories: one per row -->
          <div id="categories" class="flex flex-col gap-5"></div>

          <div class="flex items-center gap-3">
            <button id="generateBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Generate Narrative</button>
            <button id="saveBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-medium">Save Event</button>
          </div>
        </div>
      </section>

      <aside class="space-y-6">
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-2">Summary</h3>
          <div class="grid grid-cols-2 gap-3 text-sm" id="summaryPills"></div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-3">Risk Profile</h3>
          <canvas id="radarChart" height="300"></canvas>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="text-lg font-semibold mb-2">Auto-Narrative</h3>
          <p id="narrative" class="text-slate-700 leading-relaxed">Press <em>Generate Narrative</em> to produce a tailored summary.</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- Leave confirmation modal -->
  <div id="leaveModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
      <h4 class="text-lg font-semibold mb-2">Discard unsaved changes?</h4>
      <p class="text-slate-600 mb-4">You have unsaved changes. If you continue, your edits will be lost.</p>
      <div class="flex justify-end gap-2">
        <button id="keepEditingBtn" class="px-4 py-2 rounded-xl border">Continue editing</button>
        <button id="discardChangesBtn" class="px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white">Discard changes</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config: 7-category framework (Option A) + mitigations + effectiveness + gaps + enable toggles =====
    const CFG = {
      categories: [
        { key:'people', title:'People', enabled:false, sub:[
          {id:'p_life', label:'Life safety (injury, fatality)'},
          {id:'p_health', label:'Health & wellbeing (physical, psychological)'},
          {id:'p_vuln', label:'Socio-economic vulnerabilities'}
        ]},
        { key:'buildings', title:'Buildings & Infrastructure', enabled:false, sub:[
          {id:'b_stock', label:'Premises (domestic, commercial, industrial, heritage, high-risk)'},
          {id:'b_cni', label:'Critical national infrastructure (energy, water, transport, comms)'},
          {id:'b_transport', label:'Roads / rail / bridges / tunnels impacts'}
        ]},
        { key:'environment', title:'Environment', enabled:false, sub:[
          {id:'e_nat', label:'Natural environment (wildfire, flood, storms, climate)'},
          {id:'e_poll', label:'Pollution (chemical, smoke, water contamination)'},
          {id:'e_biodiv', label:'Biodiversity & heritage landscapes'}
        ]},
        { key:'ff', title:'Firefighter & Responder Safety', enabled:false, sub:[
          {id:'f_haz', label:'Exposure to hazardous materials'},
          {id:'f_struct', label:'Structural collapse / entrapment / fatigue'},
          {id:'f_psych', label:'Psychological harm and wellbeing'}
        ]},
        { key:'community', title:'Community & Society', enabled:false, sub:[
          {id:'c_trust', label:'Public expectations and trust in FRS'},
          {id:'c_cohesion', label:'Social cohesion / impacts on vulnerable communities'},
          {id:'c_disrupt', label:'Wider community impact of disruption / failure to respond'}
        ]},
        { key:'economy', title:'Economy / Business Continuity', enabled:false, sub:[
          {id:'ec_local', label:'Local economy (businesses, jobs, tourism)'},
          {id:'ec_supply', label:'Supply chains / critical services disruption'},
          {id:'ec_fin', label:'Financial harm to individuals / communities'}
        ]},
        { key:'reputation', title:'Reputation / Organisational Impact', enabled:false, sub:[
          {id:'r_conf', label:'Confidence in the service'},
          {id:'r_legal', label:'Legal / statutory compliance'},
          {id:'r_multi', label:'Impact on partner agencies / multi-agency reputation'}
        ]}
      ],
      likelihoodId:'o_likelihood',
      radarMax: 6,
      mitigationSteps: { 1:0.00, 2:0.10, 3:0.25, 4:0.40, 5:0.60 }
    };

    // ===== Stateless in-memory store (hazards + items) =====
    let editingId = null;           // current item (hazardous event) being edited
    let editingHazardId = null;     // remembered hazard for starting new events

    const SessionStore = {
      _items: [],      // hazardous events
      _hazards: [],    // hazards
      _nextItemId: 1,
      _nextHazId: 1,

      // Events
      add(rec){ const id=this._nextItemId++; const copy={...rec, id}; this._items.unshift(copy); return Promise.resolve({id}); },
      put(rec){ if(!rec.id) return this.add(rec); const i=this._items.findIndex(x=>x.id===rec.id); if(i>-1) this._items[i]=JSON.parse(JSON.stringify(rec)); else this._items.unshift(JSON.parse(JSON.stringify(rec))); return Promise.resolve({id:rec.id}); },
      getAll(){ return Promise.resolve(this._items.map(x=>JSON.parse(JSON.stringify(x)))); },
      get(id){ const it=this._items.find(x=>x.id===id); return Promise.resolve(it? JSON.parse(JSON.stringify(it)) : null ); },
      delete(id){ this._items = this._items.filter(x=>x.id!==id); return Promise.resolve(); },

      // Hazards
      addHazard(title){ const id=this._nextHazId++; this._hazards.push({ id, title: String(title||'Untitled Hazard').trim() }); return Promise.resolve({id}); },
      putHazard(haz){ const i=this._hazards.findIndex(h=>h.id===haz.id); if(i>-1) this._hazards[i] = { id: haz.id, title: String(haz.title||'Untitled Hazard').trim() }; return Promise.resolve({id: haz.id}); },
      getAllHazards(){ return Promise.resolve(this._hazards.map(h=> ({ id:h.id, title:h.title }) )); },
      deleteHazard(id){ // reassign events to uncategorised (null)
        this._hazards = this._hazards.filter(h=>h.id!==id);
        this._items = this._items.map(ev => (ev.hazardId===id ? { ...ev, hazardId: null } : ev));
        return Promise.resolve();
      },

      // Import/Reset
      setAll(payload){
        const items = Array.isArray(payload?.items) ? payload.items : [];
        const hazards = Array.isArray(payload?.hazards) ? payload.hazards : [];
        this._items = []; this._hazards = [];
        this._nextItemId = 1; this._nextHazId = 1;
        hazards.forEach(h => { this._hazards.push({ id: this._nextHazId++, title: String(h.title||'Untitled Hazard') }); });
        items.forEach(it => { this._items.push({ ...it, id: this._nextItemId++ }); });
      }
    };

    // ===== Helpers =====
    const el = (id)=> document.getElementById(id);
    const clamp15 = (n)=> Math.max(1, Math.min(5, Number(n||0)));
    const round1 = (x)=> Math.round(x*10)/10;
    const enabledOf = (key)=> (el('en_'+key)?.checked ?? false);
    function mitigationReduction(eff){
      const e = clamp15(eff);
      if (CFG.mitigationSteps) { const v = CFG.mitigationSteps[e]; return typeof v === 'number' ? v : 0; }
      return ((e-1)/4) * 0.4;
    }

    // ===== Build Category UI blocks =====
    const catRoot = el('categories');
    function buildCategoryBlocks(){
      const frag = document.createDocumentFragment();
      CFG.categories.forEach(cat=>{
        const box = document.createElement('div');
        box.className = 'border rounded-2xl p-4';
        box.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-semibold">${cat.title}</h2>
            <div class="flex items-center gap-2">
              <span class="text-sm text-slate-600">Include</span>
              <label class="switch">
                <input id="en_${cat.key}" type="checkbox" ${cat.enabled?'checked':''}>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div id="sec_${cat.key}_body" class="space-y-3">
            ${cat.sub.map(sf=>`
              <div class="flex items-center justify-between gap-3">
                <label class="w-56">${sf.label}</label>
                <input id="${sf.id}" type="number" min="1" max="5" value="3" class="w-20 text-center border rounded-lg py-1" />
              </div>
            `).join('')}
            <div class="flex items-center justify-between gap-3 pt-2 border-t">
              <span class="w-56 font-medium">Inherent ${cat.title} Score</span>
              <output id="roll_${cat.key}" class="w-24 text-center font-semibold">3.0</output>
            </div>

            <!-- Existing Mitigations UI -->
            <div class="mt-3 p-3 rounded-xl bg-emerald-50 border border-emerald-200">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-emerald-900">Existing mitigations</span>
                <div class="flex items-center gap-2">
                  <input id="mit_${cat.key}_input" type="text" placeholder="Add a mitigation…" class="px-2 py-1 text-sm border rounded-lg w-56" />
                  <button id="mit_${cat.key}_add" class="px-2 py-1 text-sm rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white" title="Add mitigation">+ Add</button>
                </div>
              </div>
              <div id="mit_${cat.key}_list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Gaps UI -->
            <div class="mt-3 p-3 rounded-xl bg-rose-50 border border-rose-200">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-rose-900">Identified gaps</span>
                <div class="flex items-center gap-2">
                  <input id="gap_${cat.key}_input" type="text" placeholder="Add a gap…" class="px-2 py-1 text-sm border rounded-lg w-56" />
                  <button id="gap_${cat.key}_add" class="px-2 py-1 text-sm rounded-lg bg-rose-600 hover:bg-rose-700 text-white">+ Add</button>
                </div>
              </div>
              <div id="gap_${cat.key}_list" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Effectiveness control AFTER mitigations/gaps -->
            <div class="flex items-center justify-between gap-3 mt-2">
              <label class="w-56">Mitigation effectiveness (1-5)</label>
              <input id="eff_${cat.key}" type="number" min="1" max="5" value="1" class="w-20 text-center border rounded-lg py-1" />
            </div>

            <!-- Current Score AFTER mitigations -->
            <div class="flex items-center justify-between gap-3 pt-2 border-t">
              <span class="w-56 font-medium">Current ${cat.title} Score</span>
              <output id="roll_adj_${cat.key}" class="w-24 text-center font-semibold">3.0</output>
            </div>
          </div>`;
        frag.appendChild(box);
      });

      // Likelihood block
      const like = document.createElement('div');
      like.className = 'border rounded-2xl p-4';
      like.innerHTML = `
        <h2 class="text-xl font-semibold mb-2">Likelihood</h2>
        <div class="flex items-center justify-between gap-3">
          <label class="w-56">Likelihood of occurrence</label>
          <input id="${CFG.likelihoodId}" type="number" min="1" max="5" value="3" class="w-20 text-center border rounded-lg py-1" />
        </div>
        <div class="flex items-center justify-between gap-3 pt-2 border-t">
          <span class="w-56 font-medium">Overall (L × Max current)</span>
          <output id="overall_out" class="w-24 text-center font-semibold">0.0</output>
        </div>`;
      frag.appendChild(like);

      catRoot.appendChild(frag);

      // Apply initial visibility according to default enabled flags (all off by default)
      CFG.categories.forEach(c=> toggleSectionBody(c.key, enabledOf(c.key)) );
    }

    // Summary pills
    const pillsRoot = el('summaryPills');
    function buildPillsDynamic(rollsAdj, perCatRisk, overall){
      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      let html = enabledCats.map(cat=>{
        const val = Number.isFinite(perCatRisk?.[cat.key]) ? Number(perCatRisk[cat.key]) : 0;
        return `
        <div class="p-3 rounded-xl bg-slate-50">
          <div class="text-slate-500">${cat.title}</div>
          <div id="pill_${cat.key}" class="text-2xl font-bold">${val.toFixed(1)}</div>
          <div class="text-xs text-slate-500">impact × likelihood</div>
        </div>`;
      }).join('');
      const ov = Number.isFinite(overall) ? overall : 0;
      html += `
        <div class="p-3 rounded-xl bg-slate-50 col-span-2">
          <div class="text-slate-500">Overall (Max impact × L)</div>
          <div id="pill_overall" class="text-2xl font-bold">${ov.toFixed(1)}</div>
        </div>`;
      pillsRoot.innerHTML = html;
    }

    // ===== Calculations =====
    function calcRoll(cat){
      const vals = cat.sub.map(sf=> clamp15(el(sf.id).value));
      if(!vals.length) return 0;
      const sorted = vals.slice().sort((a,b)=> b-a);
      const top = sorted[0];
      const others = sorted.slice(1);
      const sumOthersTenths = others.reduce((a,b)=> a + (b/10), 0);
      return round1(top + sumOthersTenths);
    }

    function calcAdjusted(cat){
      const base = calcRoll(cat);
      const eff = clamp15(el('eff_'+cat.key).value);
      const reduction = mitigationReduction(eff);
      const adj = Math.max(0, base * (1 - reduction));
      return { base, eff, adj: round1(adj) };
    }

    function recalc(){
      const rollsAdj = {};
      CFG.categories.forEach(cat=>{
        const { base, adj } = calcAdjusted(cat);
        el('roll_'+cat.key).textContent = base.toFixed(1);
        el('roll_adj_'+cat.key).textContent = adj.toFixed(1);
        if(enabledOf(cat.key)) rollsAdj[cat.key] = adj;
      });
      const like = clamp15(el(CFG.likelihoodId).value);
      const perCatRisk = {};
      Object.keys(rollsAdj).forEach(k=>{ perCatRisk[k] = round1(rollsAdj[k] * like); });
      const vals = Object.values(rollsAdj);
      const maxAdj = vals.length ? Math.max(...vals) : 0;
      const overall = round1(maxAdj * like);
      el('overall_out').textContent = overall.toFixed(1);
      buildPillsDynamic(rollsAdj, perCatRisk, overall);
      drawRadar(rollsAdj);
    }

    // ===== Mitigations helpers =====
    function mitListEl(key){ return el(`mit_${key}_list`); }
    function mitInputEl(key){ return el(`mit_${key}_input`); }
    function getMitigations(key){
      const list = mitListEl(key); if(!list) return [];
      return Array.from(list.querySelectorAll('span[data-text]')).map(s=> s.getAttribute('data-text'));
    }
    function renderMitigationChip(key, text){
      const span = document.createElement('span');
      span.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs';
      span.setAttribute('data-text', text);
      span.innerHTML = `<span class="truncate max-w-[14rem]" title="${text}">${text}</span>
        <button type="button" class="ml-1 rounded-full px-1 text-emerald-900 hover:bg-emerald-200" aria-label="Remove" data-role="remove">×</button>`;
      span.querySelector('[data-role="remove"]').addEventListener('click', ()=>{ span.remove(); recalc(); });
      mitListEl(key).appendChild(span);
    }
    function setMitigations(key, arr){
      const list = mitListEl(key); if(!list) return;
      list.innerHTML = '';
      (arr||[]).forEach(t=>{ if(t && String(t).trim()) renderMitigationChip(key, String(t).trim()); });
    }
    function addMitigation(key, text){
      const t = (text ?? mitInputEl(key)?.value ?? '').trim();
      if(!t) return;
      renderMitigationChip(key, t);
      if(mitInputEl(key)) mitInputEl(key).value = '';
      recalc();
    }

    // ===== Gaps helpers =====
    function gapListEl(key){ return el(`gap_${key}_list`); }
    function gapInputEl(key){ return el(`gap_${key}_input`); }
    function getGaps(key){
      const list = gapListEl(key); if(!list) return [];
      return Array.from(list.querySelectorAll('span[data-text]')).map(s=> s.getAttribute('data-text'));
    }
    function renderGapChip(key, text){
      const span = document.createElement('span');
      span.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-100 text-rose-800 text-xs';
      span.setAttribute('data-text', text);
      span.innerHTML = `<span class="truncate max-w-[14rem]" title="${text}">${text}</span>
        <button type="button" class="ml-1 rounded-full px-1 text-rose-900 hover:bg-rose-200" aria-label="Remove" data-role="remove">×</button>`;
      span.querySelector('[data-role="remove"]').addEventListener('click', ()=>{ span.remove(); recalc(); });
      gapListEl(key).appendChild(span);
    }
    function setGaps(key, arr){
      const list = gapListEl(key); if(!list) return;
      list.innerHTML = '';
      (arr||[]).forEach(t=>{ if(t && String(t).trim()) renderGapChip(key, String(t).trim()); });
    }
    function addGap(key, text){
      const t = (text ?? gapInputEl(key)?.value ?? '').trim();
      if(!t) return;
      renderGapChip(key, t);
      if(gapInputEl(key)) gapInputEl(key).value = '';
      recalc();
    }

    // ===== Lightweight radar
    function drawRadar(rolls){
      const canvas = document.getElementById('radarChart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      if (!canvas.style.width) canvas.style.width = '100%';
      if (!canvas.style.height) canvas.style.height = '300px';
      const rect = canvas.getBoundingClientRect();
      const cssW = Math.max(1, rect.width || 300);
      const cssH = Math.max(1, rect.height || 300);
      canvas.width = Math.round(cssW * dpr); canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      const labels = enabledCats.map(c=>c.title);
      const values = enabledCats.map(c=> rolls[c.key] ?? 0);
      if (!labels.length) { return; }
      const max = 6;

      const pad = 24; const cx = cssW/2; const cy = cssH/2; const radius = Math.min(cssW, cssH)/2 - pad - 10;
      const steps = max;

      ctx.lineWidth = 1;
      ctx.strokeStyle = '#cbd5e1';

      for(let s=1; s<=steps; s++){
        const r = radius * (s/max);
        ctx.beginPath();
        for(let i=0;i<labels.length;i++){
          const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
          const x = cx + r * Math.cos(ang);
          const y = cy + r * Math.sin(ang);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath(); ctx.stroke();
      }

      ctx.strokeStyle = '#e2e8f0';
      for(let i=0;i<labels.length;i++){
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const x = cx + radius * Math.cos(ang);
        const y = cy + radius * Math.sin(ang);
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
      }

      ctx.fillStyle = '#475569';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      for(let i=0;i<labels.length;i++){
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const lx = cx + (radius + 12) * Math.cos(ang);
        const ly = cy + (radius + 12) * Math.sin(ang);
        ctx.fillText(labels[i], lx, ly);
      }

      const points = values.map((v,i)=>{
        const ang = (Math.PI*2 * i/labels.length) - Math.PI/2;
        const r = radius * (v/max);
        return [cx + r*Math.cos(ang), cy + r*Math.sin(ang)];
      });
      ctx.beginPath();
      points.forEach(([x,y],i)=>{ if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.closePath();
      ctx.fillStyle = 'rgba(99,102,241,0.15)';
      ctx.strokeStyle = 'rgba(99,102,241,0.9)';
      ctx.lineWidth = 2;
      ctx.fill(); ctx.stroke();
      ctx.fillStyle = 'rgba(99,102,241,0.9)';
      points.forEach(([x,y])=>{ ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
    }

    // ===== Narrative =====
    function genNarrative(){
      const title = (el('riskTitle').value||'This hazardous event').trim();
      const like = clamp15(el(CFG.likelihoodId).value);
      const enabledCats = CFG.categories.filter(c=> enabledOf(c.key));
      const adjs = {}; enabledCats.forEach(cat=>{ adjs[cat.key]=calcAdjusted(cat).adj; });
      const maxCat = enabledCats.length ? enabledCats.reduce((best,cur)=> (adjs[cur.key] > adjs[best.key] ? cur : best), enabledCats[0]) : null;
      const strong = enabledCats.filter(c=> adjs[c.key] >= 4.8).map(c=>c.title);

      const parts = [];
      parts.push(`${title} has a likelihood of ${like}/5${maxCat?` with strongest current impacts in ${maxCat.title}.`:'.'}`);
      if(strong.length) parts.push('High-impact categories (after mitigation) include: ' + strong.join(', ') + '.');
      if(maxCat){
        const topMits = getMitigations(maxCat.key);
        if(topMits.length){ parts.push(`Existing mitigations for ${maxCat.title}: ${topMits.slice(0,3).join('; ')}${topMits.length>3?' …':''}.`); }
        const topGaps = getGaps(maxCat.key);
        if(topGaps.length){ parts.push(`Key gaps for ${maxCat.title}: ${topGaps.slice(0,3).join('; ')}${topGaps.length>3?' …':''}.`); }
      }
      parts.push('Priorities should focus on prevention, preparedness, and mitigation aligned to the highest residual risks.');

      el('narrative').textContent = parts.join(' ');
    }

    // ===== Import/Export (deep-link) =====
    function toBase64Safe(str){ try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return btoa(str); } }
    function fromBase64Safe(b64){ try { return decodeURIComponent(escape(atob(b64))); } catch(e){ return atob(b64); } }
    function getAppUrl(){
      const href = (window.location && window.location.href ? window.location.href : '').split('#')[0];
      if(/^https?:/i.test(href)) return href;
      const meta = document.querySelector('meta[data-app-url]');
      if(meta && /^https?:/i.test(meta.content)) return meta.content.trim();
      return '';
    }
    function importFromHash(){
      if(!location.hash || !location.hash.startsWith('#import=')) return;
      const enc = location.hash.slice('#import='.length);
      try{
        const json = fromBase64Safe(enc);
        const data = JSON.parse(json);
        const payload = {
          hazards: Array.isArray(data?.hazards) ? data.hazards : [],
          items: Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : [])
        };
        SessionStore.setAll(payload);
        refreshHazardsAccordion();
        alert('Imported from link');
      }catch(e){
        console.error('Hash import failed', e);
        alert('Failed to import from link');
      } finally {
        history.replaceState(null, document.title, location.pathname + location.search);
      }
    }

    function copySavedLink(){
      Promise.all([SessionStore.getAll(), SessionStore.getAllHazards()]).then(([items, hazards])=>{
        const payload={ version:1, exportedAt:new Date().toISOString(), items, hazards };
        const enc=toBase64Safe(JSON.stringify(payload));
        const appUrl = getAppUrl() || window.location.href.split('#')[0];
        const link=appUrl + '#import=' + enc;
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(link).then(()=> alert('Import link copied to clipboard.')).catch(()=>{ prompt('Copy this link:', link); });
        } else { prompt('Copy this link:', link); }
      });
    }

    async function saveAsLauncher(){
      try{
        const [items, hazards] = await Promise.all([SessionStore.getAll(), SessionStore.getAllHazards()]);
        const payload={ version:1, exportedAt:new Date().toISOString(), items, hazards };
        const enc = toBase64Safe(JSON.stringify(payload));
        const appUrl = getAppUrl() || window.location.href.split('#')[0];
        const target = appUrl + '#import=' + enc;
        const launcher = '<!doctype html>'+
          '<html><head><meta charset="utf-8"><title>Risk Register Launcher</title></head><body>'+
          '<script>location.href = "'+ target.replace(/"/g,'&quot;') +'";<\/script>'+
          '<p>Launching Community Risk Register…</p>'+
          '</body></html>';

        if(window.showSaveFilePicker){
          const handle = await window.showSaveFilePicker({
            suggestedName: 'launch_community_risks.html',
            types: [{ description: 'HTML', accept: { 'text/html': ['.html', '.htm'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(new Blob([launcher], { type: 'text/html' }));
          await writable.close();
          alert('Launcher saved. Open it later to load these hazards and events.');
          return;
        }

        const blob=new Blob([launcher],{type:'text/html'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='launch_community_risks.html';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }catch(err){
        console.error('Save As failed', err);
        alert('Save As failed: '+(err?.message||err));
      }
    }

    // ===== Editor collect/save =====
    function collectCurrent(){
      const inputs={}; CFG.categories.forEach(c=> c.sub.forEach(sf=> inputs[sf.id]=el(sf.id).value ));
      inputs[CFG.likelihoodId]=el(CFG.likelihoodId).value;
      const rolls={}; const adjs={}; const effs={}; const enabled={}; const risks={};
      CFG.categories.forEach(c=>{ const r=calcAdjusted(c); rolls[c.key]=r.base; adjs[c.key]=r.adj; effs[c.key]=r.eff; enabled[c.key]=enabledOf(c.key); });
      const like=clamp15(inputs[CFG.likelihoodId]);
      Object.keys(adjs).forEach(k=>{ if(enabled[k]) risks[k]=round1(adjs[k]*like); });
      const currentVals = Object.entries(adjs).filter(([k,_])=> enabled[k]).map(([_,v])=>v);
      const overall = round1((currentVals.length? Math.max(...currentVals):0) * like);
      const mitigations={}; CFG.categories.forEach(c=> mitigations[c.key]=getMitigations(c.key));
      const gaps={}; CFG.categories.forEach(c=> gaps[c.key]=getGaps(c.key));
      return {
        ...(editingId!=null?{id:editingId}:{ }),
        hazardId: parseInt(el('hazardSel').value, 10) || null,
        title:(el('riskTitle').value||'Untitled Hazardous Event').trim(),
        framework7:{ inputs, rolls, adjs, risks, effs, like, overall, mitigations, gaps, enabled, mitigationSteps: CFG.mitigationSteps },
        narrative: el('narrative').textContent,
        createdAt: new Date().toISOString()
      };
    }

    function saveCurrent(){
      const rec=collectCurrent();
      const op = (editingId!=null) ? SessionStore.put(rec) : SessionStore.add(rec);
      op.then(({id})=>{ editingId = id || editingId; refreshHazardsAccordion(); switchToList(); })
        .catch(err=>{ console.error('Save failed', err); alert('Save failed: '+(err?.message||err)); });
    }

    function loadEvent(id){
      SessionStore.get(id).then(r=>{
        if(!r) return;
        editingId=r.id;
        populateHazardSelect(r.hazardId ?? null);
        el('riskTitle').value=r.title||'';
        const f=r.framework7||{}; const inputs=f.inputs||{}; const enabled=f.enabled||{};
        CFG.categories.forEach(c=> c.sub.forEach(sf=>{ if(el(sf.id)) el(sf.id).value = inputs[sf.id] ?? 3; }));
        if(el(CFG.likelihoodId)) el(CFG.likelihoodId).value = inputs[CFG.likelihoodId] ?? 3;
        const effs=f.effs||{}; CFG.categories.forEach(c=>{ if(el('eff_'+c.key)) el('eff_'+c.key).value = effs[c.key] ?? 1; });
        const mits=(f.mitigations)||{}; CFG.categories.forEach(c=> setMitigations(c.key, mits[c.key]||[]));
        const gaps=(f.gaps)||{}; CFG.categories.forEach(c=> setGaps(c.key, gaps[c.key]||[]));
        CFG.categories.forEach(c=>{ const chk = el('en_'+c.key); if(chk){ chk.checked = enabled[c.key]===true; toggleSectionBody(c.key, chk.checked); } });
        recalc();
        el('narrative').textContent = r.narrative || el('narrative').textContent;
        switchToEditor();
      });
    }

    // ===== Hazard UI =====
    function renderHazardsAccordion(hazards, items){
      const root = el('hazardsAccordion');
      if(!hazards.length && !items.length){
        root.innerHTML = `<div class="text-slate-500">No Hazards or Hazardous Events yet. Use <strong>Add Hazard</strong> or <strong>Add Hazardous Event</strong> to begin.</div>`;
        return;
      }

      // Build map hazardId => items[]
      const byHaz = new Map();
      hazards.forEach(h=> byHaz.set(h.id, []));
      const uncategorised = [];
      items.forEach(ev=>{
        if(ev.hazardId && byHaz.has(ev.hazardId)) byHaz.get(ev.hazardId).push(ev);
        else uncategorised.push(ev);
      });

      const blocks = [];

      // Render hazards
      hazards.forEach(h=>{
        blocks.push(hazardBlock(h, byHaz.get(h.id) || []));
      });

      // Render Uncategorised if any
      if(uncategorised.length){
        blocks.push(hazardBlock({ id:null, title:'Uncategorised' }, uncategorised, true));
      }

      root.innerHTML = blocks.join('');
      // Wire row clicks and hazard action buttons
      root.querySelectorAll('table[data-hazard] tbody tr').forEach(tr=>{
        tr.addEventListener('click',(e)=>{
          const id=Number(tr.dataset.id);
          const act=e.target?.dataset?.action;
          if(act==='del'){ e.stopPropagation(); SessionStore.delete(id).then(()=> refreshHazardsAccordion()); return; }
          if(act==='dup'){ e.stopPropagation(); duplicateEvent(id); return; }
          loadEvent(id);
        });
      });
      root.querySelectorAll('[data-action="haz-rename"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const hid = btn.dataset.id==='null' ? null : Number(btn.dataset.id);
          if(hid===null){ alert('Cannot rename the Uncategorised group.'); return; }
          SessionStore.getAllHazards().then(hzs=>{
            const hz = hzs.find(z=> z.id===hid);
            if(!hz) return;
            const t = prompt('Rename hazard:', hz.title);
            if(t && t.trim()){ SessionStore.putHazard({ id:hid, title:t.trim() }).then(()=> refreshHazardsAccordion()); }
          });
        });
      });
      root.querySelectorAll('[data-action="haz-delete"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const hid = btn.dataset.id==='null' ? null : Number(btn.dataset.id);
          if(hid===null){ alert('Uncategorised cannot be deleted.'); return; }
          if(!confirm('Delete this hazard? All associated events will be moved to Uncategorised.')) return;
          SessionStore.deleteHazard(hid).then(()=> refreshHazardsAccordion());
        });
      });
    }

    function hazardBlock(h, rows, isUncat=false){
      const count = rows.length;
      const subtitle = isUncat ? 'Events without a hazard' : `${count} event${count===1?'':'s'}`;
      const hazIdAttr = (h.id===null ? 'null' : String(h.id));
      const headerActions = isUncat
        ? ''
        : `<div class="flex gap-2">
             <button data-action="haz-rename" data-id="${hazIdAttr}" class="px-2 py-1 rounded-lg border">Rename</button>
             <button data-action="haz-delete" data-id="${hazIdAttr}" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700">Delete</button>
           </div>`;

      const tableRows = (rows||[]).sort((a,b)=> (a.createdAt>b.createdAt?-1:1)).map(r=>{
        const f=r.framework7||{}; const adjs=f.adjs||{}; const enabled=f.enabled||{}; const risks=f.risks||{}; const like=f.like||0;
        const show = (k)=> {
          if(enabled[k]===false) return '-';
          if(Number.isFinite(risks[k])) return risks[k];
          if(Number.isFinite(adjs[k]) && Number.isFinite(like)) return round1(Number(adjs[k]) * Number(like));
          return adjs[k] ?? '-';
        };
        const date=r.createdAt? new Date(r.createdAt).toLocaleString():'';
        const overall=f.overall??'-';
        return `<tr class="border-b hover:bg-slate-50 cursor-pointer" data-id="${r.id}">
          <td class="py-2 pr-4">${r.title}</td>
          <td class="py-2 pr-4">${show('people')}</td>
          <td class="py-2 pr-4">${show('buildings')}</td>
          <td class="py-2 pr-4">${show('environment')}</td>
          <td class="py-2 pr-4">${show('ff')}</td>
          <td class="py-2 pr-4">${show('community')}</td>
          <td class="py-2 pr-4">${show('economy')}</td>
          <td class="py-2 pr-4">${show('reputation')}</td>
          <td class="py-2 pr-4">${overall}</td>
          <td class="py-2 pr-4 text-slate-500">${date}</td>
          <td class="py-2 pr-4">
            <button data-action="edit" data-id="${r.id}" class="px-2 py-1 rounded-lg border mr-1">Edit</button>
            <button data-action="dup" data-id="${r.id}" class="px-2 py-1 rounded-lg border mr-1">Duplicate</button>
            <button data-action="del" data-id="${r.id}" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700">Delete</button>
          </td>
        </tr>`;
      }).join('');

      return `
      <details class="rounded-xl border">
        <summary class="cursor-pointer select-none flex items-center justify-between p-4">
          <div class="flex items-center gap-3">
            <svg class="chev transition-transform" width="16" height="16" viewBox="0 0 20 20"><path fill="currentColor" d="M7 5l6 5-6 5V5z"/></svg>
            <div>
              <div class="font-semibold">${h.title || 'Untitled Hazard'}</div>
              <div class="text-sm text-slate-500">${subtitle}</div>
            </div>
          </div>
          ${headerActions}
        </summary>
        <div class="p-4 pt-0">
          <div class="overflow-x-auto mt-3">
            <table class="min-w-full text-sm" data-hazard="${hazIdAttr}">
              <thead>
                <tr class="text-left">
                  <th class="py-2 pr-4">Event Title</th>
                  <th class="py-2 pr-4">People</th>
                  <th class="py-2 pr-4">Buildings/Infra</th>
                  <th class="py-2 pr-4">Environment</th>
                  <th class="py-2 pr-4">FF Safety</th>
                  <th class="py-2 pr-4">Community/Society</th>
                  <th class="py-2 pr-4">Economy</th>
                  <th class="py-2 pr-4">Reputation</th>
                  <th class="py-2 pr-4">Overall</th>
                  <th class="py-2 pr-4">Saved</th>
                  <th class="py-2 pr-4">Actions</th>
                </tr>
              </thead>
              <tbody>${tableRows || ''}</tbody>
            </table>
          </div>
        </div>
      </details>`;
    }

    function refreshHazardsAccordion(){
      Promise.all([SessionStore.getAllHazards(), SessionStore.getAll()]).then(([hazards, items])=>{
        renderHazardsAccordion(hazards, items);
      });
    }

    function duplicateEvent(id){
      SessionStore.get(id).then(r=>{
        if(!r) return;
        const { id:_omit, createdAt:__omit, ...rest } = r;
        const copy={ ...rest, title: r.title+' (copy)', createdAt: new Date().toISOString() };
        return SessionStore.add(copy);
      }).then(()=> refreshHazardsAccordion()).catch(err=>{ console.error('Duplicate failed', err); alert('Duplicate failed: '+(err?.message||err)); });
    }

    // ===== Hazard select in editor =====
    function populateHazardSelect(selectedId){
      SessionStore.getAllHazards().then(hazards=>{
        const sel = el('hazardSel');
        const options = [
          `<option value="">(Uncategorised)</option>`,
          ...hazards.map(h=> `<option value="${h.id}">${h.title}</option>`)
        ].join('');
        sel.innerHTML = options;
        sel.value = (selectedId==null ? '' : String(selectedId));
      });
    }

    // ===== View switching & dirty tracking =====
    function getFormState(){
      const s={ title: (el('riskTitle').value||'').trim(), hazardSel: el('hazardSel').value||'' };
      CFG.categories.forEach(c=> c.sub.forEach(sf=> s[sf.id]=el(sf.id).value ));
      s[CFG.likelihoodId]=el(CFG.likelihoodId).value;
      CFG.categories.forEach(c=> s['mit_'+c.key] = getMitigations(c.key).join('|') );
      CFG.categories.forEach(c=> s['gap_'+c.key] = getGaps(c.key).join('|') );
      CFG.categories.forEach(c=> s['eff_'+c.key] = el('eff_'+c.key).value );
      CFG.categories.forEach(c=> s['en_'+c.key] = enabledOf(c.key) ? '1' : '0');
      return s;
    }
    let baseline=null;
    function snapshot(){ baseline=getFormState(); }
    function isDirty(){ if(!baseline) return false; return JSON.stringify(getFormState())!==JSON.stringify(baseline); }

    function showModal(){ el('leaveModal').classList.remove('hidden'); el('leaveModal').classList.add('flex'); }
    function hideModal(){ el('leaveModal').classList.add('hidden'); el('leaveModal').classList.remove('flex'); }
    let pendingLeave=null;
    el('keepEditingBtn').addEventListener('click', ()=>{ pendingLeave=null; hideModal(); });
    el('discardChangesBtn').addEventListener('click', ()=>{ const fn=pendingLeave; pendingLeave=null; hideModal(); if(typeof fn==='function') fn(); });

    function switchToList(){
      document.getElementById('listView').classList.remove('hidden');
      document.getElementById('editorView').classList.add('hidden');
      editingId=null; baseline=null;
    }
    function switchToEditor(){
      document.getElementById('listView').classList.add('hidden');
      document.getElementById('editorView').classList.remove('hidden');
      snapshot();
    }
    function attemptLeave(next){ if(isDirty()){ pendingLeave=next; showModal(); } else { next(); } }

    // ===== Toggle include section bodies =====
    function toggleSectionBody(key, on){
      const body = el('sec_'+key+'_body');
      if(!body) return;
      if(on){ body.classList.remove('hidden'); body.classList.remove('opacity-50'); }
      else { body.classList.add('hidden'); }
    }

    // ===== Wire-up =====
    function wire(){
      // Category inputs
      CFG.categories.forEach(c=> c.sub.forEach(sf=> el(sf.id).addEventListener('input', recalc)));
      el(CFG.likelihoodId).addEventListener('input', recalc);
      CFG.categories.forEach(c=> el('eff_'+c.key).addEventListener('input', recalc));

      // Include toggles
      CFG.categories.forEach(c=>{
        const chk = el('en_'+c.key);
        if(chk){
          chk.addEventListener('change', ()=>{ toggleSectionBody(c.key, chk.checked); recalc(); });
        }
      });

      // Mitigations & Gaps add/enter
      CFG.categories.forEach(c=>{
        const mitAddBtn = el(`mit_${c.key}_add`);
        const mitInp = el(`mit_${c.key}_input`);
        if(mitAddBtn) mitAddBtn.addEventListener('click', ()=> addMitigation(c.key));
        if(mitInp) mitInp.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); addMitigation(c.key); }});
        const gapAddBtn = el(`gap_${c.key}_add`);
        const gapInp = el(`gap_${c.key}_input`);
        if(gapAddBtn) gapAddBtn.addEventListener('click', ()=> addGap(c.key));
        if(gapInp) gapInp.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); addGap(c.key); }});
      });

      // Global buttons
      el('copyLinkBtn').addEventListener('click', copySavedLink);
      el('saveAsBtn').addEventListener('click', saveAsLauncher);
      el('generateBtn').addEventListener('click', genNarrative);
      el('saveBtn').addEventListener('click', saveCurrent);

      // Add Event
      el('addEventBtn').addEventListener('click', ()=>{
        editingId=null;
        populateHazardSelect(editingHazardId ?? null);
        el('riskTitle').value='';
        CFG.categories.forEach(c=>{ c.sub.forEach(sf=> el(sf.id).value=3 ); if(el('eff_'+c.key)) el('eff_'+c.key).value=1; setMitigations(c.key, []); setGaps(c.key, []); const chk=el('en_'+c.key); if(chk){ chk.checked=false; toggleSectionBody(c.key, false);} });
        el(CFG.likelihoodId).value=3; recalc();
        el('narrative').textContent='Press Generate Narrative to produce a tailored summary.';
        switchToEditor();
      });

      // Add Hazard
      el('addHazardBtn').addEventListener('click', ()=>{
        const t = prompt('New hazard title:','');
        if(!t || !t.trim()) return;
        SessionStore.addHazard(t.trim()).then(()=> refreshHazardsAccordion());
      });

      // Back/Cancel/Reset
      el('backToListBtn').addEventListener('click', ()=> attemptLeave(()=> switchToList()));
      el('cancelBtn').addEventListener('click', ()=> attemptLeave(()=> switchToList()));
      el('resetBtn').addEventListener('click', ()=>{
        if(!confirm('Reset this form to defaults?')) return;
        CFG.categories.forEach(c=>{
          c.sub.forEach(sf=>{ const inp=el(sf.id); if(inp) inp.value=3; });
          const eff=el('eff_'+c.key); if(eff) eff.value=1;
          setMitigations(c.key, []);
          setGaps(c.key, []);
        });
        el(CFG.likelihoodId).value=3;
        recalc();
        el('narrative').textContent='Press Generate Narrative to produce a tailored summary.';
      });
    }

    // ===== Boot =====
    (function init(){
      buildCategoryBlocks();
      buildPillsDynamic({}, {}, 0);
      wire();
      importFromHash();
      refreshHazardsAccordion();
      switchToList();
      recalc();
    })();

    // ===== Minimal self-tests =====
    (function tests(){
      try{
        // calcRoll 5,4,3 => 5.7
        el('ec_local').value=5; el('ec_supply').value=4; el('ec_fin').value=3;
        const econCat = CFG.categories.find(c=>c.key==='economy');
        const r = calcRoll(econCat);
        console.assert(Math.abs(r-5.7)<1e-9, 'calcRoll(5,4,3) should be 5.7, got '+r);
      }catch(e){ console.warn('Test(calcRoll) skipped:', e.message); }
      try{
        // Enable economy only and likelihood 5 => overall 28.5
        CFG.categories.forEach(c=>{ const ck=el('en_'+c.key); if(ck){ ck.checked=false; toggleSectionBody(c.key,false);} });
        const cke = el('en_economy'); cke.checked=true; toggleSectionBody('economy', true);
        el('ec_local').value=5; el('ec_supply').value=4; el('ec_fin').value=3;
        el('eff_economy').value=1;
        el(CFG.likelihoodId).value=5; recalc();
        console.assert(Number(el('overall_out').textContent)===28.5, 'Overall should be 28.5');
      }catch(e){ console.warn('Test(overall) skipped:', e.message); }
      try{
        // Hazards create + delete cascade to uncategorised (reassign)
        SessionStore.setAll({ hazards:[], items:[] });
        SessionStore.addHazard('Flooding').then(({id})=>{
          return SessionStore.add({ title:'River flood', hazardId:id, framework7:{}, createdAt:new Date().toISOString() })
            .then(()=> SessionStore.deleteHazard(id))
            .then(()=> SessionStore.getAll())
            .then(items=> console.assert(items[0].hazardId===null, 'Event should be uncategorised after hazard delete'));
        });
      }catch(e){ console.warn('Test(hazard reassign) skipped:', e.message); }
    })();
  </script>
</body>
</html>
